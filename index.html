<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapportini Cantiere - Sistema Completo</title>
    <style>
        /* Aggiungi questi nuovi stili alla fine del CSS esistente */
        
        /* Lavorazioni */
        .work-category {
            margin-bottom: 25px;
            border: 2px solid #eaeef5;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .work-category-header {
            background: #f0f5ff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .work-category-header:hover {
            background: #e9f2ff;
        }
        
        .work-category-header.active {
            background: #2c5aa0;
            color: white;
            border-bottom-color: #1a3c8b;
        }
        
        .work-category-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .work-category-content.active {
            padding: 20px;
            max-height: 1000px;
        }
        
        .work-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 15px;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #eee;
        }
        
        .work-item:hover {
            background: #f8faff;
            border-color: #cfe2ff;
        }
        
        /* Modal lavorazioni */
        .work-template {
            border: 1px dashed #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: move;
        }
        
        .work-template:hover {
            border-color: #2c5aa0;
            background: #f8faff;
        }
        
        /* Summary lavorazioni */
        .work-summary {
            background: linear-gradient(135deg, #f8fafc 0%, #f0f5ff 100%);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .work-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #dee2e6;
        }
        
        /* Responsive */
        @media (max-width: 992px) {
            .work-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .work-item-actions {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
            }
        }
        
        /* Worker specific works */
        .worker-works-list {
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid #eaeef5;
        }
        
        .worker-work-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        /* Costi per lavorazione */
        .work-cost-input {
            max-width: 120px;
        }
        
        .work-total-badge {
            background: #28a745;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            margin-left: 10px;
        }
        
        /* Template library */
        .template-library {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .template-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .template-card:hover {
            border-color: #2c5aa0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .template-title {
            font-weight: bold;
            color: #1a3c8b;
            margin-bottom: 8px;
        }
        
        /* Progress bar lavori */
        .work-progress {
            height: 8px;
            background: #eaeef5;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .work-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2c5aa0, #4d7bc9);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        /* Quick add lavori */
        .quick-work-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .quick-work-btn {
            padding: 8px 16px;
            background: #e9f2ff;
            border: 1px solid #cfe2ff;
            border-radius: 20px;
            color: #1a3c8b;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }
        
        .quick-work-btn:hover {
            background: #dce7ff;
            transform: translateY(-2px);
        }
        
        .quick-work-btn.active {
            background: #2c5aa0;
            color: white;
            border-color: #1a3c8b;
        }
    </style>
</head>
<body>
    <!-- Login Screen (rimane uguale) -->
    <!-- Main App (rimane uguale) -->
    
    <!-- Aggiungi questa nuova sezione nel tab Nuovo Rapportino, dopo i subappaltatori -->
    <!--
    <div class="tab-content" id="newReport">
        ... esistente ...
        
        <!-- NUOVA SEZIONE: Lavorazioni di Cantiere -->
        <div class="form-section" id="worksSection">
            <h3 class="section-title">üî® Lavorazioni di Cantiere
                <button type="button" class="btn btn-sm btn-success" onclick="openWorkTemplates()">
                    üìö Biblioteca Lavori
                </button>
                <button type="button" class="btn btn-sm btn-info" onclick="openManageModal('workCategories')">
                    üóÇÔ∏è Gestisci Categorie
                </button>
            </h3>
            
            <div id="worksAlert" class="alert alert-info" style="display: none;">
                <span class="alert-icon">üí°</span>
                <span id="worksAlertText">Aggiungi le lavorazioni eseguite oggi in cantiere</span>
            </div>
            
            <!-- Categorie lavori (dinamiche) -->
            <div id="workCategoriesContainer">
                <!-- Popolato dinamicamente -->
            </div>
            
            <!-- Aggiungi nuova lavorazione -->
            <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                <h4 style="color: #1a3c8b; margin-bottom: 15px;">‚ûï Aggiungi Nuova Lavorazione</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Categoria Lavoro</label>
                        <select id="newWorkCategory" class="form-control" onchange="updateWorkSubcategories()">
                            <option value="">Seleziona categoria...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Sotto-categoria</label>
                        <select id="newWorkSubcategory" class="form-control">
                            <option value="">Seleziona tipo...</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Descrizione Lavoro *</label>
                        <input type="text" id="newWorkDescription" class="form-control" 
                               placeholder="Es. Getto calcestruzzo fondazioni">
                    </div>
                    <div class="form-group">
                        <label>Quantit√†</label>
                        <input type="number" id="newWorkQuantity" class="form-control" min="0" step="0.01" value="1">
                    </div>
                    <div class="form-group">
                        <label>Unit√† di misura</label>
                        <select id="newWorkUnit" class="form-control">
                            <option value="ore">Ore</option>
                            <option value="m2">m¬≤</option>
                            <option value="m3">m¬≥</option>
                            <option value="ml">ml</option>
                            <option value="pz">Pezzi</option>
                            <option value="kg">kg</option>
                            <option value="l">Litri</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Tempo Impiegato (ore) *</label>
                        <input type="number" id="newWorkHours" class="form-control" min="0" max="24" step="0.5" value="1">
                    </div>
                    <div class="form-group">
                        <label>Chi ha eseguito *</label>
                        <select id="newWorkPerformer" class="form-control" multiple style="height: auto; min-height: 42px;">
                            <!-- Popolato dinamicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Costo/Unit√† (‚Ç¨)</label>
                        <input type="number" id="newWorkCost" class="form-control" min="0" step="0.01" value="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Note</label>
                        <textarea id="newWorkNotes" class="form-control" rows="2" placeholder="Note specifiche sul lavoro..."></textarea>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="addWorkItem()">
                        ‚ûï Aggiungi Lavorazione
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="saveWorkTemplate()">
                        üíæ Salva come Template
                    </button>
                </div>
            </div>
            
            <!-- Riepilogo lavorazioni -->
            <div class="work-summary">
                <h4 style="color: #1a3c8b; margin-bottom: 15px;">üìä Riepilogo Lavorazioni</h4>
                <div class="work-summary-item">
                    <span>Totale Lavorazioni:</span>
                    <strong id="totalWorksCount">0</strong>
                </div>
                <div class="work-summary-item">
                    <span>Ore Totali Lavori:</span>
                    <strong id="totalWorksHours">0</strong>
                </div>
                <div class="work-summary-item">
                    <span>Quantit√† Totale:</span>
                    <strong id="totalWorksQuantity">0</strong>
                </div>
                <div class="work-summary-item" style="border-bottom: none; font-weight: bold;">
                    <span>Costo Stimato Lavori:</span>
                    <strong style="color: #28a745;" id="totalWorksCost">0 ‚Ç¨</strong>
                </div>
            </div>
            
            <!-- Quick buttons per lavori comuni -->
            <div class="quick-work-buttons" id="quickWorksButtons">
                <!-- Popolato dinamicamente -->
            </div>
        </div>
        
        ... esistente continua ...
    -->
    
    <!-- Aggiungi questa nuova modal -->
    <!--
    <div id="workTemplatesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>üìö Biblioteca Lavorazioni</h3>
                <button class="close-modal" onclick="closeModal('workTemplatesModal')">√ó</button>
            </div>
            <div id="workTemplatesContent">
                <!-- Popolato dinamicamente -->
            </div>
        </div>
    </div>
    -->

    <script>
        // AGGIUNGI QUESTE VARIABILI ALL'INIZIO DEL SCRIPT
        let workCategories = [];
        let workTemplates = [];
        let currentWorks = [];
        
        // CATEGORIE LAVORI PREDEFINITE
        const DEFAULT_WORK_CATEGORIES = [
            {
                id: 1,
                name: "Scavi e Fondazioni",
                subcategories: ["Scavo meccanico", "Scavo manuale", "Fondazioni", "Platee", "Pali"],
                icon: "‚õèÔ∏è"
            },
            {
                id: 2,
                name: "Strutture in Cemento",
                subcategories: ["Carpenterie", "Getti", "Finiture", "Pavimenti", "Travi", "Pilastri"],
                icon: "üèóÔ∏è"
            },
            {
                id: 3,
                name: "Murature",
                subcategories: ["Muratura portante", "Tramezzi", "Intonaci", "Rasature", "Isolamenti"],
                icon: "üß±"
            },
            {
                id: 4,
                name: "Impianti",
                subcategories: ["Elettrico", "Idraulico", "Termico", "Climatizzazione", "Antincendio"],
                icon: "üîå"
            },
            {
                id: 5,
                name: "Finitura Interna",
                subcategories: ["Pavimenti", "Rivestimenti", "Cartongesso", "Pittura", "Infissi"],
                icon: "üé®"
            },
            {
                id: 6,
                name: "Esterno e Strutture",
                subcategories: ["Coperture", "Facilit√†", "Pavimentazioni esterne", "Recinzioni", "Scale"],
                icon: "üè°"
            }
        ];
        
        // MODELLO LAVORAZIONE
        class WorkItem {
            constructor(data = {}) {
                this.id = data.id || Date.now() + Math.random();
                this.category = data.category || "";
                this.subcategory = data.subcategory || "";
                this.description = data.description || "";
                this.quantity = data.quantity || 1;
                this.unit = data.unit || "ore";
                this.hours = data.hours || 0;
                this.performers = data.performers || []; // Array di {type: 'worker'|'subcontractor', id: X}
                this.costPerUnit = data.costPerUnit || 0;
                this.totalCost = data.totalCost || 0;
                this.notes = data.notes || "";
                this.date = data.date || new Date().toISOString().split('T')[0];
                this.materials = data.materials || []; // Array di materiali usati
                this.status = data.status || "completed"; // planned, in-progress, completed
            }
            
            calculateCost() {
                this.totalCost = this.quantity * this.costPerUnit;
                return this.totalCost;
            }
        }
        
        // INIZIALIZZAZIONE - Aggiungi queste chiamate nel DOMContentLoaded
        function loadWorksData() {
            // Carica categorie
            const savedCategories = localStorage.getItem('cantiereWorkCategories');
            if (savedCategories) {
                workCategories = JSON.parse(savedCategories);
            } else {
                workCategories = DEFAULT_WORK_CATEGORIES;
                saveWorkCategories();
            }
            
            // Carica templates
            const savedTemplates = localStorage.getItem('cantiereWorkTemplates');
            if (savedTemplates) {
                workTemplates = JSON.parse(savedTemplates);
            } else {
                // Templates predefiniti
                workTemplates = [
                    {
                        id: 1,
                        name: "Scavo meccanico fondazioni",
                        category: "Scavi e Fondazioni",
                        subcategory: "Scavo meccanico",
                        description: "Scavo per fondazioni con escavatore",
                        unit: "m3",
                        typicalHours: 4,
                        typicalQuantity: 50,
                        typicalCost: 25 // ‚Ç¨/m3
                    },
                    {
                        id: 2,
                        name: "Getto calcestruzzo platea",
                        category: "Strutture in Cemento",
                        subcategory: "Getti",
                        description: "Getto platea in calcestruzzo C25/30",
                        unit: "m3",
                        typicalHours: 8,
                        typicalQuantity: 30,
                        typicalCost: 120 // ‚Ç¨/m3
                    }
                ];
                saveWorkTemplates();
            }
            
            // Inizializza UI lavori
            initWorksUI();
        }
        
        // INIZIALIZZA UI LAVORI
        function initWorksUI() {
            // Crea la sezione lavorazioni
            createWorksSection();
            
            // Popola select categorie
            updateWorkCategorySelect();
            
            // Popola select performer
            updateWorkPerformerSelect();
            
            // Aggiorna categorie lavori UI
            updateWorkCategoriesUI();
            
            // Aggiorna quick buttons
            updateQuickWorkButtons();
        }
        
        // CREA SEZIONE LAVORI NEL FORM
        function createWorksSection() {
            const newReportSection = document.getElementById('newReport');
            const subcontractorSection = document.querySelector('#newReport .form-section:has(#subcontractorsList)');
            
            const worksHTML = `
                <div class="form-section" id="worksSection">
                    <h3 class="section-title">üî® Lavorazioni di Cantiere
                        <button type="button" class="btn btn-sm btn-success" onclick="openWorkTemplates()">
                            üìö Biblioteca Lavori
                        </button>
                        <button type="button" class="btn btn-sm btn-info" onclick="openManageModal('workCategories')">
                            üóÇÔ∏è Gestisci Categorie
                        </button>
                    </h3>
                    
                    <div id="worksAlert" class="alert alert-info">
                        <span class="alert-icon">üí°</span>
                        <span>Aggiungi le lavorazioni eseguite oggi in cantiere</span>
                    </div>
                    
                    <div id="workCategoriesContainer">
                        <!-- Popolato dinamicamente -->
                    </div>
                    
                    <div style="margin-top: 30px; padding: 20px; background: #f8fafc; border-radius: 8px;">
                        <h4 style="color: #1a3c8b; margin-bottom: 15px;">‚ûï Aggiungi Nuova Lavorazione</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Categoria Lavoro</label>
                                <select id="newWorkCategory" class="form-control" onchange="updateWorkSubcategories()">
                                    <option value="">Seleziona categoria...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sotto-categoria</label>
                                <select id="newWorkSubcategory" class="form-control">
                                    <option value="">Seleziona tipo...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Descrizione Lavoro *</label>
                                <input type="text" id="newWorkDescription" class="form-control" 
                                       placeholder="Es. Getto calcestruzzo fondazioni">
                            </div>
                            <div class="form-group">
                                <label>Quantit√†</label>
                                <input type="number" id="newWorkQuantity" class="form-control" min="0" step="0.01" value="1">
                            </div>
                            <div class="form-group">
                                <label>Unit√† di misura</label>
                                <select id="newWorkUnit" class="form-control">
                                    <option value="ore">Ore</option>
                                    <option value="m2">m¬≤</option>
                                    <option value="m3">m¬≥</option>
                                    <option value="ml">ml</option>
                                    <option value="pz">Pezzi</option>
                                    <option value="kg">kg</option>
                                    <option value="l">Litri</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Tempo Impiegato (ore) *</label>
                                <input type="number" id="newWorkHours" class="form-control" min="0" max="24" step="0.5" value="1">
                            </div>
                            <div class="form-group">
                                <label>Chi ha eseguito *</label>
                                <select id="newWorkPerformer" class="form-control" multiple style="height: auto; min-height: 42px;">
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Costo/Unit√† (‚Ç¨)</label>
                                <input type="number" id="newWorkCost" class="form-control" min="0" step="0.01" value="0">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Note</label>
                                <textarea id="newWorkNotes" class="form-control" rows="2" placeholder="Note specifiche sul lavoro..."></textarea>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button type="button" class="btn btn-success" onclick="addWorkItem()">
                                ‚ûï Aggiungi Lavorazione
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="saveWorkTemplate()">
                                üíæ Salva come Template
                            </button>
                        </div>
                    </div>
                    
                    <div class="work-summary">
                        <h4 style="color: #1a3c8b; margin-bottom: 15px;">üìä Riepilogo Lavorazioni</h4>
                        <div class="work-summary-item">
                            <span>Totale Lavorazioni:</span>
                            <strong id="totalWorksCount">0</strong>
                        </div>
                        <div class="work-summary-item">
                            <span>Ore Totali Lavori:</span>
                            <strong id="totalWorksHours">0</strong>
                        </div>
                        <div class="work-summary-item">
                            <span>Quantit√† Totale:</span>
                            <strong id="totalWorksQuantity">0</strong>
                        </div>
                        <div class="work-summary-item" style="border-bottom: none; font-weight: bold;">
                            <span>Costo Stimato Lavori:</span>
                            <strong style="color: #28a745;" id="totalWorksCost">0 ‚Ç¨</strong>
                        </div>
                    </div>
                    
                    <div class="quick-work-buttons" id="quickWorksButtons">
                    </div>
                </div>
            `;
            
            if (subcontractorSection) {
                subcontractorSection.insertAdjacentHTML('afterend', worksHTML);
            }
        }
        
        // POPOLA SELECT CATEGORIE
        function updateWorkCategorySelect() {
            const select = document.getElementById('newWorkCategory');
            if (!select) return;
            
            select.innerHTML = '<option value="">Seleziona categoria...</option>' +
                workCategories.map(cat => `
                    <option value="${cat.id}">${cat.icon || 'üìÅ'} ${cat.name}</option>
                `).join('');
        }
        
        // AGGIORNA SOTTO-CATEGORIE
        function updateWorkSubcategories() {
            const categoryId = document.getElementById('newWorkCategory').value;
            const subSelect = document.getElementById('newWorkSubcategory');
            
            subSelect.innerHTML = '<option value="">Seleziona tipo...</option>';
            
            if (!categoryId) return;
            
            const category = workCategories.find(c => c.id == categoryId);
            if (category && category.subcategories) {
                category.subcategories.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub}">${sub}</option>`;
                });
            }
        }
        
        // POPOLA SELECT PERFORMER
        function updateWorkPerformerSelect() {
            const select = document.getElementById('newWorkPerformer');
            if (!select) return;
            
            let options = '';
            
            // Operai
            workers.filter(w => w.active).forEach(worker => {
                options += `<option value="worker_${worker.id}">üë∑ ${worker.name} (Operaio)</option>`;
            });
            
            // Subappaltatori
            subcontractors.filter(s => s.active).forEach(sub => {
                options += `<option value="sub_${sub.id}">üè¢ ${sub.name} (Subappaltatore)</option>`;
            });
            
            select.innerHTML = options;
        }
        
        // AGGIUNGI LAVORAZIONE
        function addWorkItem() {
            const categoryId = document.getElementById('newWorkCategory').value;
            const subcategory = document.getElementById('newWorkSubcategory').value;
            const description = document.getElementById('newWorkDescription').value.trim();
            const quantity = parseFloat(document.getElementById('newWorkQuantity').value);
            const unit = document.getElementById('newWorkUnit').value;
            const hours = parseFloat(document.getElementById('newWorkHours').value);
            const performerElements = document.getElementById('newWorkPerformer').selectedOptions;
            const costPerUnit = parseFloat(document.getElementById('newWorkCost').value);
            const notes = document.getElementById('newWorkNotes').value.trim();
            
            // Validazioni
            if (!description) {
                alert('Inserisci la descrizione del lavoro');
                return;
            }
            
            if (isNaN(hours) || hours <= 0) {
                alert('Inserisci un numero di ore valido');
                return;
            }
            
            if (performerElements.length === 0) {
                alert('Seleziona chi ha eseguito il lavoro');
                return;
            }
            
            const category = workCategories.find(c => c.id == categoryId);
            
            // Crea array performers
            const performers = Array.from(performerElements).map(opt => {
                const value = opt.value;
                if (value.startsWith('worker_')) {
                    const workerId = value.split('_')[1];
                    const worker = workers.find(w => w.id == workerId);
                    return {
                        type: 'worker',
                        id: workerId,
                        name: worker ? worker.name : 'Operaio sconosciuto'
                    };
                } else if (value.startsWith('sub_')) {
                    const subId = value.split('_')[1];
                    const sub = subcontractors.find(s => s.id == subId);
                    return {
                        type: 'subcontractor',
                        id: subId,
                        name: sub ? sub.name : 'Subappaltatore sconosciuto'
                    };
                }
                return null;
            }).filter(p => p !== null);
            
            // Crea lavorazione
            const workItem = new WorkItem({
                category: category ? category.name : '',
                subcategory: subcategory,
                description: description,
                quantity: quantity || 1,
                unit: unit,
                hours: hours,
                performers: performers,
                costPerUnit: costPerUnit,
                notes: notes
            });
            
            // Calcola costo
            workItem.calculateCost();
            
            // Aggiungi alla lista corrente
            currentWorks.push(workItem);
            
            // Aggiorna UI
            updateWorksUI();
            updateWorkSummary();
            
            // Resetta form
            resetWorkForm();
            
            // Mostra conferma
            showAlert('‚úÖ Lavorazione aggiunta con successo!', 'success', 'worksAlert');
        }
        
        // AGGIORNA UI LAVORI
        function updateWorksUI() {
            const container = document.getElementById('workCategoriesContainer');
            if (!container) return;
            
            // Raggruppa lavorazioni per categoria
            const worksByCategory = {};
            currentWorks.forEach(work => {
                if (!worksByCategory[work.category]) {
                    worksByCategory[work.category] = [];
                }
                worksByCategory[work.category].push(work);
            });
            
            // Crea UI per ogni categoria
            let html = '';
            
            workCategories.forEach(category => {
                const categoryWorks = worksByCategory[category.name] || [];
                
                if (categoryWorks.length === 0) return;
                
                html += `
                    <div class="work-category">
                        <div class="work-category-header" onclick="toggleWorkCategory(${category.id})">
                            <div>
                                <strong>${category.icon || 'üìÅ'} ${category.name}</strong>
                                <span class="badge badge-primary" style="margin-left: 10px;">${categoryWorks.length} lavori</span>
                            </div>
                            <div>‚ñ∂Ô∏è</div>
                        </div>
                        <div class="work-category-content" id="categoryContent_${category.id}">
                            ${categoryWorks.map(work => renderWorkItem(work)).join('')}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <p>Nessuna lavorazione aggiunta</p>
                    <p class="small">Aggiungi lavorazioni dal form qui sotto</p>
                </div>
            `;
        }
        
        // RENDER SINGOLA LAVORAZIONE
        function renderWorkItem(work) {
            const performerNames = work.performers.map(p => p.name).join(', ');
            
            return `
                <div class="work-item" id="work_${work.id}">
                    <div>
                        <strong>${work.description}</strong>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">
                            <span>${work.subcategory || 'Generico'}</span> ‚Ä¢ 
                            <span>Eseguito da: ${performerNames}</span>
                        </div>
                        ${work.notes ? `<div style="font-size: 0.85rem; color: #777; margin-top: 3px;">üìù ${work.notes}</div>` : ''}
                    </div>
                    
                    <div>
                        <strong>${work.quantity} ${work.unit}</strong>
                    </div>
                    
                    <div>
                        <strong>${work.hours} ore</strong>
                    </div>
                    
                    <div>
                        <strong style="color: ${work.totalCost > 0 ? '#28a745' : '#666'}">
                            ${work.totalCost.toFixed(2)} ‚Ç¨
                        </strong>
                    </div>
                    
                    <div class="work-item-actions">
                        <button class="btn btn-sm btn-warning" onclick="editWorkItem('${work.id}')">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="removeWorkItem('${work.id}')">
                            ‚ùå
                        </button>
                    </div>
                </div>
            `;
        }
        
        // TOGGLE CATEGORIA (espandi/contrai)
        function toggleWorkCategory(categoryId) {
            const content = document.getElementById(`categoryContent_${categoryId}`);
            const header = content.previousElementSibling;
            
            content.classList.toggle('active');
            header.classList.toggle('active');
            
            // Cambia icona
            const icon = header.querySelector('div:last-child');
            icon.textContent = content.classList.contains('active') ? '‚ñº' : '‚ñ∂Ô∏è';
        }
        
        // AGGIORNA RIEPILOGO
        function updateWorkSummary() {
            const totalWorks = currentWorks.length;
            const totalHours = currentWorks.reduce((sum, work) => sum + work.hours, 0);
            const totalQuantity = currentWorks.reduce((sum, work) => sum + work.quantity, 0);
            const totalCost = currentWorks.reduce((sum, work) => sum + work.totalCost, 0);
            
            document.getElementById('totalWorksCount').textContent = totalWorks;
            document.getElementById('totalWorksHours').textContent = totalHours.toFixed(1);
            document.getElementById('totalWorksQuantity').textContent = totalQuantity.toFixed(2);
            document.getElementById('totalWorksCost').textContent = totalCost.toFixed(2) + ' ‚Ç¨';
        }
        
        // RIMUOVI LAVORAZIONE
        function removeWorkItem(workId) {
            if (confirm('Eliminare questa lavorazione?')) {
                currentWorks = currentWorks.filter(w => w.id !== workId);
                updateWorksUI();
                updateWorkSummary();
            }
        }
        
        // MODIFICA LAVORAZIONE
        function editWorkItem(workId) {
            const work = currentWorks.find(w => w.id === workId);
            if (!work) return;
            
            // Popola form con dati lavorazione
            const category = workCategories.find(c => c.name === work.category);
            if (category) {
                document.getElementById('newWorkCategory').value = category.id;
                updateWorkSubcategories();
                setTimeout(() => {
                    document.getElementById('newWorkSubcategory').value = work.subcategory;
                }, 100);
            }
            
            document.getElementById('newWorkDescription').value = work.description;
            document.getElementById('newWorkQuantity').value = work.quantity;
            document.getElementById('newWorkUnit').value = work.unit;
            document.getElementById('newWorkHours').value = work.hours;
            document.getElementById('newWorkCost').value = work.costPerUnit;
            document.getElementById('newWorkNotes').value = work.notes || '';
            
            // Seleziona performers
            const performerSelect = document.getElementById('newWorkPerformer');
            Array.from(performerSelect.options).forEach(option => {
                const performerValue = work.performers.find(p => {
                    if (p.type === 'worker') return `worker_${p.id}` === option.value;
                    if (p.type === 'subcontractor') return `sub_${p.id}` === option.value;
                    return false;
                });
                option.selected = !!performerValue;
            });
            
            // Rimuovi lavorazione dalla lista
            removeWorkItem(workId);
            
            // Scrolla al form
            document.getElementById('worksSection').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('newWorkDescription').focus();
        }
        
        // RESET FORM LAVORI
        function resetWorkForm() {
            document.getElementById('newWorkDescription').value = '';
            document.getElementById('newWorkQuantity').value = 1;
            document.getElementById('newWorkHours').value = 1;
            document.getElementById('newWorkCost').value = 0;
            document.getElementById('newWorkNotes').value = '';
            document.getElementById('newWorkPerformer').selectedIndex = -1;
        }
        
        // BIBLIOTECA TEMPLATES
        function openWorkTemplates() {
            const modalContent = document.getElementById('workTemplatesContent');
            
            const categoriesHTML = workCategories.map(category => {
                const catTemplates = workTemplates.filter(t => t.category === category.name);
                
                if (catTemplates.length === 0) return '';
                
                return `
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: #1a3c8b; margin-bottom: 15px; border-bottom: 2px solid #eaeef5; padding-bottom: 8px;">
                            ${category.icon || 'üìÅ'} ${category.name}
                        </h4>
                        <div class="template-library">
                            ${catTemplates.map(template => `
                                <div class="template-card" onclick="applyWorkTemplate(${template.id})">
                                    <div class="template-title">${template.name}</div>
                                    <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
                                        ${template.subcategory || 'Generico'}
                                    </div>
                                    <div style="font-size: 0.85rem; color: #777;">
                                        <div>üìè ${template.typicalQuantity || 1} ${template.unit || 'ore'}</div>
                                        <div>‚è±Ô∏è ${template.typicalHours || 0} ore</div>
                                        <div>üí∞ ${template.typicalCost || 0} ‚Ç¨/${template.unit || 'ore'}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            
            modalContent.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="searchTemplates" class="form-control" 
                                   placeholder="üîç Cerca template..." oninput="searchTemplates()">
                        </div>
                    </div>
                </div>
                
                ${categoriesHTML || '<p style="text-align: center; padding: 40px; color: #666;">Nessun template disponibile</p>'}
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn btn-primary" onclick="createNewTemplate()">
                        ‚ûï Crea Nuovo Template
                    </button>
                </div>
            `;
            
            openModal('workTemplatesModal');
        }
        
        // APPLICA TEMPLATE
        function applyWorkTemplate(templateId) {
            const template = workTemplates.find(t => t.id === templateId);
            if (!template) return;
            
            const category = workCategories.find(c => c.name === template.category);
            
            if (category) {
                document.getElementById('newWorkCategory').value = category.id;
                updateWorkSubcategories();
                
                setTimeout(() => {
                    document.getElementById('newWorkSubcategory').value = template.subcategory || '';
                }, 100);
            }
            
            document.getElementById('newWorkDescription').value = template.name;
            document.getElementById('newWorkQuantity').value = template.typicalQuantity || 1;
            document.getElementById('newWorkUnit').value = template.unit || 'ore';
            document.getElementById('newWorkHours').value = template.typicalHours || 1;
            document.getElementById('newWorkCost').value = template.typicalCost || 0;
            
            closeModal('workTemplatesModal');
            
            // Scrolla al form
            document.getElementById('newWorkDescription').focus();
        }
        
        // SALVA COME TEMPLATE
        function saveWorkTemplate() {
            const categoryId = document.getElementById('newWorkCategory').value;
            const subcategory = document.getElementById('newWorkSubcategory').value;
            const description = document.getElementById('newWorkDescription').value.trim();
            const quantity = parseFloat(document.getElementById('newWorkQuantity').value);
            const unit = document.getElementById('newWorkUnit').value;
            const hours = parseFloat(document.getElementById('newWorkHours').value);
            const cost = parseFloat(document.getElementById('newWorkCost').value);
            
            if (!description) {
                alert('Inserisci una descrizione per il template');
                return;
            }
            
            const category = workCategories.find(c => c.id == categoryId);
            
            const newTemplate = {
                id: Date.now(),
                name: description,
                category: category ? category.name : '',
                subcategory: subcategory,
                unit: unit,
                typicalQuantity: quantity,
                typicalHours: hours,
                typicalCost: cost,
                createdAt: new Date().toISOString()
            };
            
            workTemplates.push(newTemplate);
            saveWorkTemplates();
            
            alert('‚úÖ Template salvato con successo!');
        }
        
        // GESTIONE CATEGORIE (modal)
        function getWorkCategoriesManageContent() {
            return `
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Aggiungi Nuova Categoria</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="newCategoryName" class="form-control" placeholder="Nome categoria">
                        </div>
                        <div class="form-group">
                            <input type="text" id="newCategoryIcon" class="form-control" placeholder="Icona (emoji)">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success" onclick="addNewWorkCategory()">
                                ‚ûï Aggiungi
                            </button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <input type="text" id="newSubcategories" class="form-control" 
                                   placeholder="Sottocategorie (separate da virgola)">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Categorie Esistenti</h4>
                    ${workCategories.map(category => `
                        <div class="item-card" style="margin-bottom: 15px;">
                            <div class="item-info">
                                <div class="item-title">${category.icon || 'üìÅ'} ${category.name}</div>
                                <div class="item-details">
                                    Sottocategorie: ${category.subcategories ? category.subcategories.join(', ') : 'Nessuna'}
                                </div>
                            </div>
                            <div class="item-actions">
                                <button class="btn btn-sm btn-warning" onclick="editWorkCategory(${category.id})">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteWorkCategory(${category.id})">
                                    ‚ùå
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        // AGGIUNGI NUOVA CATEGORIA
        function addNewWorkCategory() {
            const name = document.getElementById('newCategoryName').value.trim();
            const icon = document.getElementById('newCategoryIcon').value.trim();
            const subcategoriesInput = document.getElementById('newSubcategories').value.trim();
            
            if (!name) {
                alert('Inserisci il nome della categoria');
                return;
            }
            
            const subcategories = subcategoriesInput ? 
                subcategoriesInput.split(',').map(s => s.trim()).filter(s => s) : 
                [];
            
            const newCategory = {
                id: Date.now(),
                name: name,
                icon: icon || 'üìÅ',
                subcategories: subcategories
            };
            
            workCategories.push(newCategory);
            saveWorkCategories();
            
            updateWorkCategorySelect();
            updateWorkCategoriesUI();
            
            // Reset form
            document.getElementById('newCategoryName').value = '';
            document.getElementById('newCategoryIcon').value = '';
            document.getElementById('newSubcategories').value = '';
            
            showAlert('‚úÖ Categoria aggiunta con successo!', 'success');
        }
        
        // AGGIORNA UI CATEGORIE
        function updateWorkCategoriesUI() {
            const container = document.getElementById('workCategoriesContainer');
            // Viene chiamato da updateWorksUI()
        }
        
        // QUICK WORK BUTTONS
        function updateQuickWorkButtons() {
            const container = document.getElementById('quickWorksButtons');
            if (!container) return;
            
            // Lavori comuni
            const commonWorks = [
                { name: "Scavo manuale", cat: "Scavi e Fondazioni", sub: "Scavo manuale", hours: 8, qty: 10, unit: "m3" },
                { name: "Getto calcestruzzo", cat: "Strutture in Cemento", sub: "Getti", hours: 8, qty: 20, unit: "m3" },
                { name: "Muratura tramezzi", cat: "Murature", sub: "Tramezzi", hours: 8, qty: 15, unit: "m2" },
                { name: "Posa impianto elettrico", cat: "Impianti", sub: "Elettrico", hours: 8, qty: 100, unit: "ml" },
                { name: "Pittura pareti", cat: "Finitura Interna", sub: "Pittura", hours: 8, qty: 50, unit: "m2" }
            ];
            
            container.innerHTML = commonWorks.map(work => `
                <button class="quick-work-btn" onclick="addQuickWork('${work.name}', '${work.cat}', '${work.sub}', ${work.hours}, ${work.qty}, '${work.unit}')">
                    ${work.name}
                </button>
            `).join('');
        }
        
        // AGGIUNGI LAVORO RAPIDO
        function addQuickWork(name, categoryName, subcategory, hours, quantity, unit) {
            const category = workCategories.find(c => c.name === categoryName);
            
            if (category) {
                document.getElementById('newWorkCategory').value = category.id;
                updateWorkSubcategories();
                
                setTimeout(() => {
                    document.getElementById('newWorkSubcategory').value = subcategory;
                }, 100);
            }
            
            document.getElementById('newWorkDescription').value = name;
            document.getElementById('newWorkHours').value = hours;
            document.getElementById('newWorkQuantity').value = quantity;
            document.getElementById('newWorkUnit').value = unit;
            
            // Focus sul campo successivo
            document.getElementById('newWorkPerformer').focus();
        }
        
        // INTEGRAZIONE NEL SALVATAGGIO RAPPORTINO
        function saveReport() {
            // ... codice esistente ...
            
            // Aggiungi le lavorazioni al rapportino
            const report = {
                // ... campi esistenti ...
                works: [...currentWorks], // AGGIUNGI QUESTO
                totals: {
                    // ... totali esistenti ...
                    worksHours: currentWorks.reduce((sum, w) => sum + w.hours, 0),
                    worksCost: currentWorks.reduce((sum, w) => sum + w.totalCost, 0),
                    worksCount: currentWorks.length
                }
            };
            
            // ... resto del codice ...
        }
        
        // SALVA DATI LAVORI
        function saveWorkCategories() {
            localStorage.setItem('cantiereWorkCategories', JSON.stringify(workCategories));
        }
        
        function saveWorkTemplates() {
            localStorage.setItem('cantiereWorkTemplates', JSON.stringify(workTemplates));
        }
        
        // ALERT PERSONALIZZATO
        function showAlert(message, type = 'info', elementId = 'worksAlert') {
            const alertElement = document.getElementById(elementId);
            if (alertElement) {
                alertElement.className = `alert alert-${type}`;
                alertElement.querySelector('.alert-icon').textContent = 
                    type === 'success' ? '‚úÖ' : 
                    type === 'warning' ? '‚ö†Ô∏è' : 
                    type === 'danger' ? '‚ùå' : '‚ÑπÔ∏è';
                alertElement.querySelector('span:last-child').textContent = message;
                alertElement.style.display = 'flex';
                
                setTimeout(() => {
                    if (type !== 'info') {
                        alertElement.style.display = 'none';
                    }
                }, 3000);
            }
        }
        
        // MODIFICA SAVE REPORT PER INCLUDERE LAVORAZIONI
        function saveReport() {
            // ... validazioni esistenti ...
            
            // Aggiungi validazione lavorazioni se necessario
            // if (currentWorks.length === 0 && confirm('Non hai aggiunto lavorazioni. Continuare?')) {
            //     // continua senza lavorazioni
            // }
            
            const report = {
                // ... campi esistenti ...
                id: Date.now(),
                date: document.getElementById('reportDate').value,
                siteId: document.getElementById('reportSite').value,
                siteName: sites.find(s => s.id == document.getElementById('reportSite').value)?.name || '',
                // ... altri campi ...
                
                // NUOVI CAMPI LAVORAZIONI
                works: JSON.parse(JSON.stringify(currentWorks)), // deep copy
                
                totals: {
                    // ... totali esistenti ...
                    workerHours: currentReport.workers.reduce((sum, w) => sum + w.hours, 0),
                    equipmentHours: currentReport.equipment.reduce((sum, e) => sum + e.hours, 0),
                    subcontractorHours: currentReport.subcontractors.reduce((sum, s) => sum + (s.hours || 0), 0),
                    subcontractorCost: currentReport.subcontractors.reduce((sum, s) => sum + s.cost, 0),
                    
                    // TOTALI LAVORAZIONI
                    worksHours: currentWorks.reduce((sum, w) => sum + w.hours, 0),
                    worksCost: currentWorks.reduce((sum, w) => sum + w.totalCost, 0),
                    worksCount: currentWorks.length,
                    
                    // TOTALE GENERALE
                    totalHours: currentReport.workers.reduce((sum, w) => sum + w.hours, 0) +
                              currentReport.equipment.reduce((sum, e) => sum + e.hours, 0) +
                              currentReport.subcontractors.reduce((sum, s) => sum + (s.hours || 0), 0) +
                              currentWorks.reduce((sum, w) => sum + w.hours, 0),
                    
                    totalCost: currentReport.subcontractors.reduce((sum, s) => sum + s.cost, 0) +
                              currentWorks.reduce((sum, w) => sum + w.totalCost, 0)
                }
            };
            
            // ... resto del salvataggio ...
            
            // Resetta anche le lavorazioni
            currentWorks = [];
            updateWorksUI();
            updateWorkSummary();
        }
        
        // INIZIALIZZAZIONE COMPLETA
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            
            // Carica anche i dati lavori
            loadWorksData();
            
            checkAutoLogin();
            initDate();
        });
    </script>
</body>
</html>
