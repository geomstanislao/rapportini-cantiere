<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapportini Cantiere - Sistema Sincronizzato</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- QR Code library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* Tutti gli stili precedenti... */
        /* Aggiungo stili per la sincronizzazione */
        
        .sync-section {
            background: #f0f7ff;
            border-radius: 10px;
            padding: 25px;
            margin: 30px 0;
            border: 2px solid #cfe2ff;
        }
        
        .sync-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .sync-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #eaeef5;
            transition: transform 0.3s;
        }
        
        .sync-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .sync-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .qr-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        #qrcode {
            margin: 20px auto;
            display: inline-block;
        }
        
        .backup-section {
            background: #fff8e1;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #28a745;
        }
        
        .status-offline {
            background-color: #dc3545;
        }
        
        .device-list {
            list-style: none;
            padding: 0;
        }
        
        .device-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #2c5aa0;
        }
        
        .device-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .last-sync {
            font-size: 0.85rem;
            color: #666;
        }
        
        /* Stili per le nuove sezioni */
        .operaio-entry {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .operaio-entry .card-header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .lavorazioni-section, .mezzi-section {
            margin: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .lavorazione-item, .mezzo-item {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .subappalto-entry {
            animation: fadeIn 0.3s ease;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            background: #007bff;
            color: white;
            display: inline-block;
            margin: 5px;
        }
        
        .import-section {
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 2px solid #28a745;
        }
    </style>
</head>
<body>
    <!-- Qui ci sarebbe il resto del tuo HTML esistente (header, menu, tabs, ecc.) -->
    <!-- Assumo che tu abbia gi√† la struttura base -->
    
    <!-- Aggiungi questo nella tab Rapportini -->
    <div class="tab-content" id="rapportino">
        <!-- Sezione Importazione Lavorazioni -->
        <div class="import-section">
            <h4>üìã Importazione Lavorazioni da Excel</h4>
            <div class="alert alert-info" style="background: #d1ecf1; padding: 10px; border-radius: 5px;">
                <p><strong>Formato file Excel richiesto:</strong></p>
                <table style="width: 100%; margin: 10px 0; border-collapse: collapse;">
                    <tr style="background: #bee5eb;">
                        <th style="padding: 8px; border: 1px solid #86cfda;">Colonna A</th>
                        <th style="padding: 8px; border: 1px solid #86cfda;">Colonna B</th>
                        <th style="padding: 8px; border: 1px solid #86cfda;">Colonna C</th>
                        <th style="padding: 8px; border: 1px solid #86cfda;">Colonna D</th>
                    </tr>
                    <tr>
                        <td style="padding: 8px; border: 1px solid #86cfda;">Codice</td>
                        <td style="padding: 8px; border: 1px solid #86cfda;">Descrizione</td>
                        <td style="padding: 8px; border: 1px solid #86cfda;">Unit√† di misura</td>
                        <td style="padding: 8px; border: 1px solid #86cfda;">Prezzo unitario</td>
                    </tr>
                </table>
                <p>La prima riga deve contenere gli header</p>
            </div>
            
            <div class="form-row" style="margin: 20px 0;">
                <div class="form-group">
                    <button class="btn btn-primary" onclick="document.getElementById('importLavorazioniFile').click()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        üìÅ Importa Lavorazioni da Excel
                    </button>
                    <input type="file" id="importLavorazioniFile" accept=".xlsx,.xls,.csv" style="display: none;" 
                           onchange="importLavorazioniExcel(event)">
                </div>
                <div class="form-group">
                    <button class="btn btn-success" onclick="exportLavorazioniTemplate()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ‚¨áÔ∏è Scarica Template Excel
                    </button>
                </div>
            </div>
            
            <div id="lavorazioniStatus" style="padding: 10px; border-radius: 5px; display: none;">
                <span id="lavorazioniCount">0</span> lavorazioni caricate
            </div>
        </div>

        <!-- Sezione Operai Modificata -->
        <div class="form-section" id="operaiSection" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 10px;">
            <h4 class="section-title">üë∑‚Äç‚ôÇÔ∏è Operai (Senza Ore Straordinarie)</h4>
            
            <div id="operaiContainer">
                <!-- Gli operai verranno aggiunti qui dinamicamente -->
            </div>
            
            <div class="form-row" style="display: flex; gap: 20px; margin-top: 20px;">
                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="addOperaio()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        ‚ûï Aggiungi Operaio
                    </button>
                </div>
                <div class="form-group">
                    <span class="badge" id="totalOperaiHours">Totale ore: 0</span>
                </div>
            </div>
        </div>

        <!-- Sezione Subappalti Modificata -->
        <div class="form-section" id="subappaltiSection" style="margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 10px;">
            <h4 class="section-title">üèóÔ∏è Subappalti (Numero Persone)</h4>
            
            <div id="subappaltiContainer">
                <!-- I subappalti verranno aggiunti qui -->
            </div>
            
            <button type="button" class="btn btn-primary" onclick="addSubappalto()" style="padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                ‚ûï Aggiungi Subappalto
            </button>
        </div>
    </div>

    <!-- Tab Sincronizzazione (esistente) -->
    <div class="tab-content" id="sync">
        <div class="form-section">
            <h3 class="section-title">üîÑ Sincronizzazione Dati</h3>
            
            <div class="alert alert-info">
                <span>üí° Sincronizza i dati tra telefono e PC usando uno dei metodi seguenti.</span>
            </div>
            
            <div class="sync-options">
                <div class="sync-card">
                    <div class="sync-icon">üì±</div>
                    <h4>QR Code</h4>
                    <p>Scansiona il QR code da un altro dispositivo per sincronizzare</p>
                    <button class="btn btn-primary" onclick="generateQRCode()">
                        üì∑ Genera QR Code
                    </button>
                </div>
                
                <div class="sync-card">
                    <div class="sync-icon">üì§</div>
                    <h4>Esporta Dati</h4>
                    <p>Salva un file con tutti i dati per importarli su un altro dispositivo</p>
                    <button class="btn btn-success" onclick="exportSyncFile()">
                        ‚¨áÔ∏è Esporta Backup
                    </button>
                </div>
                
                <div class="sync-card">
                    <div class="sync-icon">üì•</div>
                    <h4>Importa Dati</h4>
                    <p>Carica dati da un altro dispositivo o da un backup</p>
                    <input type="file" id="importSyncFile" accept=".json" style="display: none;">
                    <button class="btn btn-warning" onclick="document.getElementById('importSyncFile').click()">
                        ‚¨ÜÔ∏è Importa Backup
                    </button>
                </div>
            </div>
            
            <!-- Backup automatico -->
            <div class="backup-section">
                <h4>üíæ Backup Automatico</h4>
                <p>I dati vengono salvati automaticamente ogni 5 minuti.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ultimo backup:</label>
                        <span id="lastBackupTime">Mai</span>
                    </div>
                    <div class="form-group">
                        <label>Dimensione dati:</label>
                        <span id="dataSize">0 KB</span>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-info" onclick="manualBackup()">
                            üîÑ Backup Ora
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Dispositivi sincronizzati -->
            <div class="form-section" style="margin-top: 30px;">
                <h4>üì± Dispositivi Connessi</h4>
                <ul class="device-list" id="deviceList">
                    <li class="device-item">
                        <div class="device-info">
                            <span class="status-indicator status-online"></span>
                            <span>Questo dispositivo</span>
                        </div>
                        <span class="last-sync">Online</span>
                    </li>
                </ul>
            </div>
            
            <!-- Opzioni avanzate -->
            <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                <h5>‚öôÔ∏è Opzioni Avanzate</h5>
                <div class="form-row">
                    <div class="form-group">
                        <button class="btn btn-danger" onclick="clearAllData()">
                            üóëÔ∏è Cancella Tutti i Dati
                        </button>
                    </div>
                    <div class="form-group">
                        <button class="btn btn-warning" onclick="resetApp()">
                            üîÑ Ripristina Impostazioni
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal QR Code -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üì± Sincronizza con QR Code</h3>
                <button class="close-modal" onclick="closeModal('qrModal')">√ó</button>
            </div>
            <div class="qr-container">
                <p>Scansiona questo QR code da un altro dispositivo:</p>
                <div id="qrcode"></div>
                <p style="margin-top: 20px; color: #666; font-size: 0.9rem;">
                    üì± Usa la fotocamera del telefono<br>
                    üíª Su PC, usa un'app per QR code
                </p>
                <button class="btn btn-primary" onclick="closeModal('qrModal')" style="margin-top: 20px;">
                    Chiudi
                </button>
            </div>
        </div>
    </div>

    <!-- Templates per gli elementi dinamici -->
    <template id="operaioTemplate">
        <div class="operaio-entry" data-operaio-id="">
            <div class="card-header">
                <div class="form-row" style="display: flex; gap: 10px; align-items: center;">
                    <div class="form-group" style="flex: 2;">
                        <label>Operaio</label>
                        <select class="select-operaio" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="">Seleziona operaio...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ore Totali</label>
                        <input type="number" class="input-ore-totali" 
                               value="8" min="0" max="24" step="0.5" readonly
                               style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeOperaio(this)" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ‚ùå Rimuovi
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <!-- Sezione Lavorazioni -->
                <div class="lavorazioni-section">
                    <h5>üî® Lavorazioni svolte</h5>
                    <div class="lavorazioni-list">
                        <!-- Le lavorazioni verranno aggiunte qui -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" 
                            onclick="addLavorazioneToOperaio(this)"
                            style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        ‚ûï Aggiungi Lavorazione
                    </button>
                </div>
                
                <!-- Sezione Mezzi -->
                <div class="mezzi-section">
                    <h5>üöú Mezzi utilizzati</h5>
                    <div class="mezzi-list">
                        <!-- I mezzi verranno aggiunti qui -->
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm" 
                            onclick="addMezzoToOperaio(this)"
                            style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">
                        ‚ûï Aggiungi Mezzo
                    </button>
                </div>
            </div>
        </div>
    </template>

    <template id="lavorazioneOperaioTemplate">
        <div class="lavorazione-item" style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px;">
            <div class="form-row" style="display: flex; gap: 10px; align-items: center;">
                <div class="form-group" style="flex: 2;">
                    <select class="select-lavorazione" onchange="updateLavorazioneInfo(this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Seleziona lavorazione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" class="input-ore-lavorazione" 
                           placeholder="Ore" min="0" max="24" step="0.5" value="8"
                           onchange="calculateOperaioHours(this)"
                           style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeLavorazione(this)" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ‚ùå
                    </button>
                </div>
            </div>
        </div>
    </template>

    <template id="mezzoOperaioTemplate">
        <div class="mezzo-item" style="background: #e8f4f8; padding: 10px; margin: 5px 0; border-radius: 5px;">
            <div class="form-row" style="display: flex; gap: 10px; align-items: center;">
                <div class="form-group" style="flex: 2;">
                    <select class="select-mezzo" onchange="updateMezzoInfo(this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Seleziona mezzo...</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="number" class="input-ore-mezzo" 
                           placeholder="Ore" min="0" max="24" step="0.5" value="0"
                           onchange="calculateOperaioHours(this)"
                           style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeMezzo(this)" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ‚ùå
                    </button>
                </div>
            </div>
        </div>
    </template>

    <template id="subappaltoTemplate">
        <div class="subappalto-entry">
            <div class="form-row" style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
                <div class="form-group" style="flex: 2;">
                    <label>Ditta Subappalto</label>
                    <select class="select-subappaltatore" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Seleziona ditta...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Numero Persone</label>
                    <input type="number" class="input-persone-sub" 
                           min="1" max="100" value="1"
                           style="width: 100px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeSubappalto(this)" style="padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        ‚ùå Rimuovi
                    </button>
                </div>
            </div>
            
            <div class="form-row" style="display: flex; gap: 10px; align-items: center;">
                <div class="form-group" style="flex: 1;">
                    <label>Lavorazione</label>
                    <select class="select-lavorazione-sub" onchange="updateSubLavorazione(this)" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">Seleziona lavorazione...</option>
                    </select>
                </div>
                <div class="form-group" style="flex: 2;">
                    <label>Descrizione Lavorazione</label>
                    <input type="text" class="input-desc-lavorazione-sub" readonly
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                </div>
            </div>
        </div>
    </template>

    <script>
        // ==================== GESTIONE LAVORAZIONI ====================
        let lavorazioniList = JSON.parse(localStorage.getItem('lavorazioniList') || '[]');
        let mezziList = JSON.parse(localStorage.getItem('cantiereEquipment') || '[]');
        let operaioCounter = 0;

        // Inizializza il sistema lavorazioni
        function initLavorazioniSystem() {
            updateLavorazioniStatus();
            populateLavorazioniSelects();
            populateMezziSelects();
            
            // Aggiungi un operaio di default
            if (document.getElementById('operaiContainer') && document.querySelectorAll('.operaio-entry').length === 0) {
                addOperaio();
            }
        }

        // Importa lavorazioni da Excel
        function importLavorazioniExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Prendi il primo foglio
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Converti in JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        alert('Il file Excel √® vuoto o non contiene dati validi');
                        return;
                    }

                    // Processa i dati (salta la prima riga di header)
                    const nuoveLavorazioni = [];
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (!row || row.length === 0) continue;
                        
                        const codice = row[0] ? row[0].toString().trim() : '';
                        const descrizione = row[1] ? row[1].toString().trim() : '';
                        
                        if (codice && descrizione) {
                            nuoveLavorazioni.push({
                                codice: codice,
                                descrizione: descrizione,
                                unitaMisura: (row[2] || 'Ora').toString().trim(),
                                prezzoUnitario: parseFloat(row[3]) || 0,
                                categoria: (row[4] || 'Generale').toString().trim()
                            });
                        }
                    }

                    if (nuoveLavorazioni.length === 0) {
                        alert('Nessuna lavorazione valida trovata nel file');
                        return;
                    }

                    // Chiedi conferma
                    if (lavorazioniList.length > 0) {
                        if (!confirm(`Ci sono gi√† ${lavorazioniList.length} lavorazioni. Vuoi:\n\n1. SOVRASCRIVERE tutte le lavorazioni\n2. AGGIUNGERE le nuove lavorazioni\n\nClicca OK per sovrascrivere, Annulla per aggiungere.`)) {
                            // Modalit√† aggiungi
                            lavorazioniList = [...lavorazioniList, ...nuoveLavorazioni];
                        } else {
                            // Modalit√† sovrascrivi
                            lavorazioniList = nuoveLavorazioni;
                        }
                    } else {
                        lavorazioniList = nuoveLavorazioni;
                    }

                    // Salva nel localStorage
                    localStorage.setItem('lavorazioniList', JSON.stringify(lavorazioniList));
                    
                    // Aggiorna UI
                    updateLavorazioniStatus();
                    populateLavorazioniSelects();
                    
                    alert(`‚úÖ ${nuoveLavorazioni.length} lavorazioni importate con successo!`);
                    
                } catch (error) {
                    console.error('Errore importazione:', error);
                    alert('Errore durante l\'importazione: ' + error.message);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Esporta template Excel
        function exportLavorazioniTemplate() {
            const templateData = [
                ['Codice', 'Descrizione', 'Unit√† di misura', 'Prezzo unitario', 'Categoria'],
                ['LAV001', 'Scavo manuale', 'Ora', '45.00', 'Terra'],
                ['LAV002', 'Getto calcestruzzo', 'm¬≥', '120.00', 'Calcestruzzo'],
                ['LAV003', 'Posa tubazioni', 'ml', '25.00', 'Idraulica'],
                ['LAV004', 'Armatura ferro', 'kg', '2.50', 'Strutture'],
                ['LAV005', 'Muratura forata', 'm¬≤', '35.00', 'Muratura']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            
            // Esporta
            XLSX.writeFile(wb, 'Template_Lavorazioni_Cantiere.xlsx');
        }

        // Popola tutti i dropdown delle lavorazioni
        function populateLavorazioniSelects() {
            const selects = document.querySelectorAll('.select-lavorazione, .select-lavorazione-sub');
            
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Seleziona lavorazione...</option>';
                
                lavorazioniList.forEach(lav => {
                    const option = document.createElement('option');
                    option.value = lav.codice;
                    option.textContent = `${lav.codice} - ${lav.descrizione}`;
                    option.dataset.descrizione = lav.descrizione;
                    option.dataset.unita = lav.unitaMisura;
                    option.dataset.prezzo = lav.prezzoUnitario;
                    select.appendChild(option);
                });
                
                if (currentValue) {
                    select.value = currentValue;
                    if (select.classList.contains('select-lavorazione-sub')) {
                        updateSubLavorazione(select);
                    }
                }
            });
        }

        // Popola dropdown mezzi
        function populateMezziSelects() {
            const selects = document.querySelectorAll('.select-mezzo');
            
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Seleziona mezzo...</option>';
                
                mezziList.forEach(mezzo => {
                    const option = document.createElement('option');
                    option.value = mezzo.id || mezzo.nome;
                    option.textContent = `${mezzo.nome} (${mezzo.tipo || 'Mezzo'})`;
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
            });
        }

        // Aggiorna stato lavorazioni
        function updateLavorazioniStatus() {
            const statusElement = document.getElementById('lavorazioniStatus');
            const countElement = document.getElementById('lavorazioniCount');
            
            if (statusElement && countElement) {
                if (lavorazioniList.length > 0) {
                    statusElement.style.display = 'block';
                    statusElement.style.background = '#d4edda';
                    statusElement.style.color = '#155724';
                    statusElement.style.padding = '10px';
                    statusElement.style.borderRadius = '5px';
                    countElement.textContent = `${lavorazioniList.length} lavorazioni caricate`;
                } else {
                    statusElement.style.display = 'block';
                    statusElement.style.background = '#fff3cd';
                    statusElement.style.color = '#856404';
                    statusElement.style.padding = '10px';
                    statusElement.style.borderRadius = '5px';
                    countElement.textContent = 'Nessuna lavorazione caricata';
                }
            }
        }

        // ==================== GESTIONE OPERAI ====================

        // Aggiungi operaio
        function addOperaio() {
            operaioCounter++;
            const container = document.getElementById('operaiContainer');
            if (!container) return;
            
            const template = document.getElementById('operaioTemplate');
            const clone = template.content.cloneNode(true);
            
            const operaioEntry = clone.querySelector('.operaio-entry');
            operaioEntry.dataset.operaioId = `operaio_${operaioCounter}`;
            
            // Popola dropdown operaio
            const selectOperaio = operaioEntry.querySelector('.select-operaio');
            const operai = JSON.parse(localStorage.getItem('cantiereWorkers') || '[]');
            
            operai.forEach(operaio => {
                const option = document.createElement('option');
                option.value = operaio.id;
                option.textContent = `${operaio.nome} ${operaio.cognome}`;
                selectOperaio.appendChild(option);
            });
            
            // Aggiungi una lavorazione di default
            addLavorazioneToOperaio(operaioEntry.querySelector('.lavorazioni-section .btn'));
            
            container.appendChild(clone);
            updateTotalOperaiHours();
        }

        // Aggiungi lavorazione a operaio
        function addLavorazioneToOperaio(button) {
            const operaioEntry = button.closest('.operaio-entry');
            const lavorazioniListDiv = operaioEntry.querySelector('.lavorazioni-list');
            const template = document.getElementById('lavorazioneOperaioTemplate');
            const clone = template.content.cloneNode(true);
            
            // Popola dropdown lavorazioni
            const selectLavorazione = clone.querySelector('.select-lavorazione');
            lavorazioniList.forEach(lav => {
                const option = document.createElement('option');
                option.value = lav.codice;
                option.textContent = `${lav.codice} - ${lav.descrizione}`;
                option.dataset.descrizione = lav.descrizione;
                selectLavorazione.appendChild(option);
            });
            
            lavorazioniListDiv.appendChild(clone);
            calculateOperaioHours(selectLavorazione);
        }

        // Aggiungi mezzo a operaio
        function addMezzoToOperaio(button) {
            const operaioEntry = button.closest('.operaio-entry');
            const mezziListDiv = operaioEntry.querySelector('.mezzi-list');
            const template = document.getElementById('mezzoOperaioTemplate');
            const clone = template.content.cloneNode(true);
            
            // Popola dropdown mezzi
            const selectMezzo = clone.querySelector('.select-mezzo');
            mezziList.forEach(mezzo => {
                const option = document.createElement('option');
                option.value = mezzo.id || mezzo.nome;
                option.textContent = `${mezzo.nome} (${mezzo.tipo || 'Mezzo'})`;
                selectMezzo.appendChild(option);
            });
            
            mezziListDiv.appendChild(clone);
            calculateOperaioHours(selectMezzo);
        }

        // Calcola ore operaio
        function calculateOperaioHours(input) {
            const operaioEntry = input.closest('.operaio-entry');
            if (!operaioEntry) return;
            
            const oreTotaliInput = operaioEntry.querySelector('.input-ore-totali');
            
            // Somma ore lavorazioni
            const oreLavorazioni = Array.from(operaioEntry.querySelectorAll('.input-ore-lavorazione'))
                .reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            
            // Somma ore mezzi
            const oreMezzi = Array.from(operaioEntry.querySelectorAll('.input-ore-mezzo'))
                .reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            
            const totale = oreLavorazioni + oreMezzi;
            if (oreTotaliInput) {
                oreTotaliInput.value = totale.toFixed(1);
            }
            
            updateTotalOperaiHours();
        }

        // Aggiorna totale ore operai
        function updateTotalOperaiHours() {
            const totalElement = document.getElementById('totalOperaiHours');
            if (!totalElement) return;
            
            const totalOperaiHours = Array.from(document.querySelectorAll('.input-ore-totali'))
                .reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
            
            totalElement.textContent = `Totale ore: ${totalOperaiHours.toFixed(1)}`;
        }

        // Rimuovi operaio
        function removeOperaio(button) {
            if (confirm('Rimuovere questo operaio?')) {
                button.closest('.operaio-entry').remove();
                updateTotalOperaiHours();
            }
        }

        // Rimuovi lavorazione
        function removeLavorazione(button) {
            button.closest('.lavorazione-item').remove();
            calculateOperaioHours(button);
        }

        // Rimuovi mezzo
        function removeMezzo(button) {
            button.closest('.mezzo-item').remove();
            calculateOperaioHours(button);
        }

        // ==================== GESTIONE SUBAPPALTI ====================

        // Aggiungi subappalto
        function addSubappalto() {
            const container = document.getElementById('subappaltiContainer');
            if (!container) return;
            
            const template = document.getElementById('subappaltoTemplate');
            const clone = template.content.cloneNode(true);
            
            // Popola dropdown subappaltatori
            const selectSubappaltatore = clone.querySelector('.select-subappaltatore');
            const subappaltatori = JSON.parse(localStorage.getItem('cantiereSubcontractors') || '[]');
            
            subappaltatori.forEach(sub => {
                const option = document.createElement('option');
                option.value = sub.id;
                option.textContent = sub.nome;
                selectSubappaltatore.appendChild(option);
            });
            
            // Popola dropdown lavorazioni per subappalto
            const selectLavorazione = clone.querySelector('.select-lavorazione-sub');
            lavorazioniList.forEach(lav => {
                const option = document.createElement('option');
                option.value = lav.codice;
                option.textContent = `${lav.codice} - ${lav.descrizione}`;
                option.dataset.descrizione = lav.descrizione;
                selectLavorazione.appendChild(option);
            });
            
            container.appendChild(clone);
        }

        // Aggiorna descrizione lavorazione per subappalto
        function updateSubLavorazione(select) {
            const descInput = select.closest('.subappalto-entry').querySelector('.input-desc-lavorazione-sub');
            const selectedOption = select.selectedOptions[0];
            
            if (selectedOption && selectedOption.dataset.descrizione) {
                descInput.value = selectedOption.dataset.descrizione;
            } else {
                descInput.value = '';
            }
        }

        // Rimuovi subappalto
        function removeSubappalto(button) {
            if (confirm('Rimuovere questo subappalto?')) {
                button.closest('.subappalto-entry').remove();
            }
        }

        // ==================== SISTEMA DI SINCRONIZZAZIONE ====================
        
        // ID univoco per ogni dispositivo
        let deviceId = localStorage.getItem('deviceId') || 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('deviceId', deviceId);
        
        // Backup automatico
        let backupInterval;
        
        // Inizializza sistema di sincronizzazione
        function initSyncSystem() {
            // Genera ID dispositivo se non esiste
            if (!localStorage.getItem('deviceId')) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            
            // Avvia backup automatico
            startAutoBackup();
            
            // Aggiorna informazioni dispositivo
            updateDeviceInfo();
            
            // Aggiorna stato backup
            updateBackupStatus();
            
            // Gestione import file
            const importSyncFile = document.getElementById('importSyncFile');
            if (importSyncFile) {
                importSyncFile.addEventListener('change', handleFileImport);
            }
            
            // Inizializza lavorazioni
            initLavorazioniSystem();
        }
        
        // Backup automatico ogni 5 minuti
        function startAutoBackup() {
            // Salva backup iniziale
            manualBackup();
            
            // Avvia intervallo
            backupInterval = setInterval(() => {
                manualBackup();
            }, 5 * 60 * 1000); // 5 minuti
        }
        
        // Backup manuale
        function manualBackup() {
            try {
                // Prepara dati per il backup
                const backupData = {
                    version: '2.0',
                    timestamp: new Date().toISOString(),
                    deviceId: deviceId,
                    deviceName: navigator.userAgent,
                    data: {
                        reports: JSON.parse(localStorage.getItem('cantiereReports') || '[]'),
                        workers: JSON.parse(localStorage.getItem('cantiereWorkers') || '[]'),
                        equipment: JSON.parse(localStorage.getItem('cantiereEquipment') || '[]'),
                        works: JSON.parse(localStorage.getItem('cantiereWorks') || '[]'),
                        subcontractors: JSON.parse(localStorage.getItem('cantiereSubcontractors') || '[]'),
                        sites: JSON.parse(localStorage.getItem('cantiereSites') || '[]'),
                        drafts: JSON.parse(localStorage.getItem('cantiereDrafts') || '[]'),
                        lavorazioni: lavorazioniList
                    }
                };
                
                // Salva backup
                localStorage.setItem('lastBackup', JSON.stringify(backupData));
                
                // Aggiorna timestamp
                const now = new Date();
                const lastBackupTime = document.getElementById('lastBackupTime');
                if (lastBackupTime) {
                    lastBackupTime.textContent = 
                        now.toLocaleTimeString('it-IT') + ' - ' + now.toLocaleDateString('it-IT');
                }
                
                // Calcola dimensione dati
                const dataSize = JSON.stringify(backupData).length;
                const dataSizeElement = document.getElementById('dataSize');
                if (dataSizeElement) {
                    dataSizeElement.textContent = Math.round(dataSize / 1024) + ' KB';
                }
                
                console.log('‚úÖ Backup completato');
            } catch (error) {
                console.error('‚ùå Errore backup:', error);
            }
        }
        
        // Aggiorna stato backup
        function updateBackupStatus() {
            const lastBackup = localStorage.getItem('lastBackup');
            const lastBackupTime = document.getElementById('lastBackupTime');
            
            if (lastBackup && lastBackupTime) {
                try {
                    const backupData = JSON.parse(lastBackup);
                    const backupDate = new Date(backupData.timestamp);
                    lastBackupTime.textContent = 
                        backupDate.toLocaleTimeString('it-IT') + ' - ' + backupDate.toLocaleDateString('it-IT');
                } catch (e) {
                    lastBackupTime.textContent = 'Errore';
                }
            }
            
            // Calcola dimensione dati
            const totalData = {
                reports: localStorage.getItem('cantiereReports') || '[]',
                workers: localStorage.getItem('cantiereWorkers') || '[]',
                equipment: localStorage.getItem('cantiereEquipment') || '[]',
                works: localStorage.getItem('cantiereWorks') || '[]',
                subcontractors: localStorage.getItem('cantiereSubcontractors') || '[]',
                sites: localStorage.getItem('cantiereSites') || '[]',
                drafts: localStorage.getItem('cantiereDrafts') || '[]',
                lavorazioni: JSON.stringify(lavorazioniList)
            };
            
            const dataSize = JSON.stringify(totalData).length;
            const dataSizeElement = document.getElementById('dataSize');
            if (dataSizeElement) {
                dataSizeElement.textContent = Math.round(dataSize / 1024) + ' KB';
            }
        }
        
        // Genera QR Code per sincronizzazione
        function generateQRCode() {
            // Prepara dati per la sincronizzazione
            const syncData = {
                type: 'cantiere_sync',
                version: '2.0',
                timestamp: new Date().toISOString(),
                deviceId: deviceId,
                data: getSyncData()
            };
            
            // Converti in stringa JSON
            const dataString = JSON.stringify(syncData);
            
            // Genera QR Code
            const qrContainer = document.getElementById('qrcode');
            if (qrContainer) {
                qrContainer.innerHTML = '';
                
                new QRCode(qrContainer, {
                    text: dataString,
                    width: 256,
                    height: 256,
                    colorDark: "#1a3c8b",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
            
            // Mostra modal
            openModal('qrModal');
        }
        
        // Prepara dati per la sincronizzazione
        function getSyncData() {
            return {
                reports: JSON.parse(localStorage.getItem('cantiereReports') || '[]'),
                workers: JSON.parse(localStorage.getItem('cantiereWorkers') || '[]'),
                equipment: JSON.parse(localStorage.getItem('cantiereEquipment') || '[]'),
                works: JSON.parse(localStorage.getItem('cantiereWorks') || '[]'),
                subcontractors: JSON.parse(localStorage.getItem('cantiereSubcontractors') || '[]'),
                sites: JSON.parse(localStorage.getItem('cantiereSites') || '[]'),
                lavorazioni: lavorazioniList,
                lastBackup: localStorage.getItem('lastBackup')
            };
        }
        
        // Esporta file di sincronizzazione
        function exportSyncFile() {
            const syncData = {
                type: 'cantiere_backup',
                version: '2.0',
                timestamp: new Date().toISOString(),
                deviceId: deviceId,
                data: getSyncData()
            };
            
            const dataStr = JSON.stringify(syncData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportFileName = `backup_cantiere_${formatDate(new Date())}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileName);
            linkElement.click();
            
            alert('‚úÖ Backup esportato con successo!');
        }
        
        // Gestione import file
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.type === 'cantiere_backup' || importedData.type === 'cantiere_sync') {
                        importSyncData(importedData);
                    } else {
                        alert('File non valido. Usa un file di backup generato dall\'app.');
                    }
                } catch (error) {
                    alert('Errore durante l\'importazione: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset input
            event.target.value = '';
        }
        
        // Importa dati di sincronizzazione
        function importSyncData(syncData) {
            if (!confirm('Vuoi importare questi dati? I dati esistenti verranno sovrascritti.')) {
                return;
            }
            
            try {
                const data = syncData.data;
                
                // Sovrascrivi tutti i dati
                if (data.reports) {
                    localStorage.setItem('cantiereReports', JSON.stringify(data.reports));
                }
                if (data.workers) {
                    localStorage.setItem('cantiereWorkers', JSON.stringify(data.workers));
                }
                if (data.equipment) {
                    localStorage.setItem('cantiereEquipment', JSON.stringify(data.equipment));
                }
                if (data.works) {
                    localStorage.setItem('cantiereWorks', JSON.stringify(data.works));
                }
                if (data.subcontractors) {
                    localStorage.setItem('cantiereSubcontractors', JSON.stringify(data.subcontractors));
                }
                if (data.sites) {
                    localStorage.setItem('cantiereSites', JSON.stringify(data.sites));
                }
                if (data.lavorazioni) {
                    lavorazioniList = data.lavorazioni;
                    localStorage.setItem('lavorazioniList', JSON.stringify(data.lavorazioni));
                    updateLavorazioniStatus();
                    populateLavorazioniSelects();
                }
                if (data.lastBackup) {
                    localStorage.setItem('lastBackup', data.lastBackup);
                }
                
                // Ricarica l'app
                alert('‚úÖ Dati importati con successo! L\'app verr√† ricaricata.');
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                alert('Errore durante l\'importazione: ' + error.message);
            }
        }
        
        // Aggiorna informazioni dispositivo
        function updateDeviceInfo() {
            const deviceList = document.getElementById('deviceList');
            if (!deviceList) return;
            
            // Aggiungi questo dispositivo
            deviceList.innerHTML = `
                <li class="device-item">
                    <div class="device-info">
                        <span class="status-indicator status-online"></span>
                        <span>${getDeviceName()}</span>
                    </div>
                    <span class="last-sync">Online ‚Ä¢ ${formatTime(new Date())}</span>
                </li>
            `;
        }
        
        // Ottieni nome dispositivo
        function getDeviceName() {
            const ua = navigator.userAgent;
            
            if (/mobile|android|iphone|ipad/i.test(ua)) {
                return 'Telefono';
            } else {
                return 'Computer';
            }
        }
        
        // Formatta data
        function formatDate(date) {
            return date.toISOString().split('T')[0].replace(/-/g, '');
        }
        
        // Formatta orario
        function formatTime(date) {
            return date.toLocaleTimeString('it-IT', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        
        // Cancella tutti i dati
        function clearAllData() {
            if (confirm('ATTENZIONE: Cancellare TUTTI i dati?\nQuesta operazione √® irreversibile!')) {
                if (confirm('Sei DAVVERO sicuro? Tutto verr√† cancellato.')) {
                    // Cancella tutti i dati locali
                    localStorage.clear();
                    lavorazioniList = [];
                    
                    // Ricarica l'app
                    alert('Tutti i dati sono stati cancellati. L\'app verr√† ricaricata.');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            }
        }
        
        // Ripristina impostazioni
        function resetApp() {
            if (confirm('Ripristinare le impostazioni predefinite?\nLe liste verranno ripristinate, ma i rapportini e le lavorazioni rimarranno.')) {
                // Mantieni rapportini e lavorazioni
                const reports = JSON.parse(localStorage.getItem('cantiereReports') || '[]');
                const currentLavorazioni = lavorazioniList;
                
                // Cancella tutto
                localStorage.clear();
                
                // Ripristina rapportini e lavorazioni
                localStorage.setItem('cantiereReports', JSON.stringify(reports));
                localStorage.setItem('lavorazioniList', JSON.stringify(currentLavorazioni));
                lavorazioniList = currentLavorazioni;
                
                // Ricarica l'app
                alert('Impostazioni ripristinate. L\'app verr√† ricaricata.');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }

        // Funzioni modal (aggiungi se non esistono)
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'block';
            }
        }
        
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Inizializza quando la pagina √® caricata
        document.addEventListener('DOMContentLoaded', function() {
            initSyncSystem();
        });
    </script>
</body>
</html>
