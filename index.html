<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapportini Cantiere - Sistema Completo</title>
    <!-- Libreria per Excel -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 90vh;
        }
        
        /* Header principale */
        .main-header {
            background: linear-gradient(135deg, #1a3c8b 0%, #2c5aa0 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .header-left h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .header-left p {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        /* User info */
        .user-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #1a3c8b;
        }
        
        .user-details h3 {
            margin-bottom: 5px;
            font-size: 1.2rem;
        }
        
        .user-details p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Tabs principali */
        .main-tabs {
            display: flex;
            background: white;
            border-bottom: 2px solid #eaeef5;
            overflow-x: auto;
        }
        
        .main-tab {
            padding: 20px 30px;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .main-tab:hover {
            background-color: #f0f5ff;
            color: #2c5aa0;
        }
        
        .main-tab.active {
            color: #2c5aa0;
            border-bottom-color: #2c5aa0;
            background-color: #f0f5ff;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Form sections */
        .form-section {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            border: 2px solid #eaeef5;
        }
        
        .section-title {
            color: #1a3c8b;
            font-size: 1.4rem;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eaeef5;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }
        
        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%231a3c8b' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
            padding-right: 40px;
        }
        
        /* Items list */
        .items-container {
            margin-top: 20px;
        }
        
        .item-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #2c5aa0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .work-item-card {
            border-left-color: #17a2b8;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-title {
            font-weight: 600;
            color: #1a3c8b;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .work-item-title {
            color: #17a2b8;
        }
        
        .item-details {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 5px;
        }
        
        .item-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: #2c5aa0;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1a3c8b;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        /* Summary boxes */
        .summary-box {
            background: #f0f7ff;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid #cfe2ff;
        }
        
        .summary-title {
            color: #1a3c8b;
            font-size: 1.3rem;
            margin-bottom: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #dce7ff;
        }
        
        .summary-row:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.1rem;
            color: #1a3c8b;
        }
        
        /* Tables */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 8px;
            border: 1px solid #eaeef5;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        
        thead {
            background: #f0f5ff;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #1a3c8b;
            border-bottom: 2px solid #eaeef5;
            white-space: nowrap;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        
        tr:hover {
            background: #f8faff;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .modal-header h3 {
            color: #1a3c8b;
            font-size: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        /* Alert messages */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* Quick actions */
        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .quick-action-btn {
            padding: 10px 20px;
            background: #e9f2ff;
            border: 2px solid #cfe2ff;
            border-radius: 8px;
            color: #1a3c8b;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quick-action-btn:hover {
            background: #dce7ff;
            transform: translateY(-2px);
        }
        
        /* Excel export section */
        .excel-export-section {
            background: #f8fff0;
            border: 2px solid #d4edda;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .export-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #eaeef5;
            text-align: center;
        }
        
        .export-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        /* Checkbox group */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        /* Worker extra options */
        .worker-extra-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .extra-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-header {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            
            .header-left h1 {
                font-size: 1.8rem;
            }
            
            .main-tabs {
                overflow-x: auto;
            }
            
            .main-tab {
                padding: 15px 20px;
                font-size: 0.9rem;
            }
            
            .tab-content {
                padding: 20px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .item-card {
                flex-direction: column;
                gap: 15px;
            }
            
            .item-actions {
                align-self: flex-end;
            }
            
            .export-options {
                grid-template-columns: 1fr;
            }
        }
        
        /* Indicators */
        .indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .indicator-transferta {
            background: #ffeaa7;
            color: #856404;
        }
        
        .indicator-pasto {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        /* Progress bar */
        .progress-bar {
            height: 8px;
            background: #eaeef5;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #28a745;
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        /* Totals display */
        .totals-display {
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #eaeef5;
        }
        
        .total-item {
            text-align: center;
            flex: 1;
            min-width: 150px;
        }
        
        .total-value {
            font-size: 2rem;
            font-weight: bold;
            color: #1a3c8b;
            margin-bottom: 5px;
        }
        
        .total-label {
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen" style="display: flex; justify-content: center; align-items: center; min-height: 70vh; padding: 40px;">
        <div class="login-box" style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); width: 100%; max-width: 400px;">
            <h2 style="color: #1a3c8b; margin-bottom: 30px; text-align: center; font-size: 2rem;">üîê Accesso Rapportini Cantiere</h2>
            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="userName">Nome Capocantiere</label>
                    <input type="text" id="userName" placeholder="Il tuo nome" required style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                </div>
                <div class="form-group">
                    <label for="userPin">PIN (4 cifre)</label>
                    <input type="password" id="userPin" placeholder="1234" maxlength="4" pattern="\d{4}" required style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem;">
                </div>
                <button type="submit" class="btn btn-primary btn-block" style="width: 100%; padding: 15px; margin-top: 10px;">
                    üö™ Accedi
                </button>
            </form>
            <div style="margin-top: 30px; text-align: center;">
                <p style="color: #666; margin-bottom: 15px;">Oppure accedi come:</p>
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-sm btn-success" onclick="quickLogin('Mario Rossi', '1234')">
                        Mario Rossi
                    </button>
                    <button class="btn btn-sm btn-success" onclick="quickLogin('Luigi Verdi', '5678')">
                        Luigi Verdi
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main App (dopo login) -->
    <div id="mainApp" class="container" style="display: none;">
        <!-- Header -->
        <div class="main-header">
            <div class="header-left">
                <h1>üèóÔ∏è Gestione Rapportini Cantiere</h1>
                <p>Sistema completo con lavorazioni e esportazione Excel</p>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">
                    üë∑
                </div>
                <div class="user-details">
                    <h3 id="currentUserName">Nome Utente</h3>
                    <p id="currentUserRole">Capocantiere</p>
                    <button class="btn btn-sm btn-danger" onclick="logout()" style="margin-top: 8px;">
                        üö™ Logout
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tabs principali -->
        <div class="main-tabs">
            <div class="main-tab active" data-tab="dashboard">
                üìä Dashboard
            </div>
            <div class="main-tab" data-tab="newReport">
                ‚úçÔ∏è Nuovo Rapportino
            </div>
            <div class="main-tab" data-tab="manage">
                ‚öôÔ∏è Gestione Liste
            </div>
            <div class="main-tab" data-tab="reports">
                üìã Archivio Rapportini
            </div>
            <div class="main-tab" data-tab="export">
                üìà Esporta Excel
            </div>
        </div>
        
        <!-- Tab Dashboard -->
        <div class="tab-content active" id="dashboard">
            <div class="quick-actions">
                <div class="quick-action-btn" onclick="switchTab('newReport')">
                    ‚úçÔ∏è Nuovo Rapportino
                </div>
                <div class="quick-action-btn" onclick="switchTab('export')">
                    üìà Esporta Excel
                </div>
                <div class="quick-action-btn" onclick="switchTab('reports')">
                    üìã Vedi Tutti i Rapportini
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-section">
                    <h3 class="section-title">üìà Statistiche</h3>
                    <div class="form-row">
                        <div>
                            <h4 style="color: #1a3c8b; margin-bottom: 10px;">Rapportini</h4>
                            <p style="font-size: 2rem; color: #1a3c8b; font-weight: bold;" id="totalReports">0</p>
                            <p style="color: #666;">Totale rapportini</p>
                        </div>
                        <div>
                            <h4 style="color: #1a3c8b; margin-bottom: 10px;">Operai</h4>
                            <p style="font-size: 2rem; color: #1a3c8b; font-weight: bold;" id="totalWorkers">0</p>
                            <p style="color: #666;">Operai registrati</p>
                        </div>
                        <div>
                            <h4 style="color: #1a3c8b; margin-bottom: 10px;">Lavorazioni</h4>
                            <p style="font-size: 2rem; color: #1a3c8b; font-weight: bold;" id="totalWorks">0</p>
                            <p style="color: #666;">Tipi di lavorazione</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <h3 class="section-title">üìÖ Rapportini Recenti</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Cantiere</th>
                                <th>Operai</th>
                                <th>Mezzi</th>
                                <th>Lavorazioni</th>
                                <th>Ore Totali</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="recentReportsTable">
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Tab Nuovo Rapportino -->
        <div class="tab-content" id="newReport">
            <div id="reportAlert" class="alert alert-info">
                <span class="alert-icon">üìù</span>
                <span>Compila il nuovo rapportino. Tutti i campi con * sono obbligatori.</span>
            </div>
            
            <!-- Informazioni base -->
            <div class="form-section">
                <h3 class="section-title">üèóÔ∏è Informazioni Cantiere</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportDate">üìÖ Data *</label>
                        <input type="date" id="reportDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="reportSite">üèóÔ∏è Cantiere *</label>
                        <select id="reportSite" class="form-control" required>
                            <option value="">Seleziona cantiere...</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="reportWeather">üå§Ô∏è Condizioni Meteo</label>
                        <select id="reportWeather" class="form-control">
                            <option value="">Seleziona...</option>
                            <option value="sole">‚òÄÔ∏è Soleggiato</option>
                            <option value="nuvoloso">‚òÅÔ∏è Nuvoloso</option>
                            <option value="pioggia">üåßÔ∏è Pioggia</option>
                            <option value="neve">‚ùÑÔ∏è Neve</option>
                            <option value="vento">üí® Ventoso</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reportNotes">üìù Note e Osservazioni</label>
                        <textarea id="reportNotes" class="form-control" rows="3" placeholder="Note sulla giornata, problemi riscontrati, ecc."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Operai -->
            <div class="form-section">
                <h3 class="section-title">üë∑ Operai
                    <button type="button" class="btn btn-sm btn-success" onclick="openManageModal('workers')">
                        ‚ûï Gestisci Operai
                    </button>
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workerSelect">Operaio *</label>
                        <select id="workerSelect" class="form-control">
                            <option value="">Seleziona operaio...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="workerHours">Ore Lavorate *</label>
                        <input type="number" id="workerHours" class="form-control" min="0" max="24" step="0.5" value="8" placeholder="Ore">
                    </div>
                </div>
                
                <!-- Opzioni extra per operaio -->
                <div class="worker-extra-options">
                    <div class="extra-option">
                        <input type="checkbox" id="workerTransferta">
                        <label for="workerTransferta">üöó Trasferta</label>
                    </div>
                    <div class="extra-option">
                        <input type="checkbox" id="workerPasto">
                        <label for="workerPasto">üçù Pasto in cantiere</label>
                    </div>
                    <div class="extra-option">
                        <input type="number" id="workerOreStraordinario" class="form-control" min="0" step="0.5" placeholder="Ore straordinario" style="width: 120px;">
                        <label for="workerOreStraordinario">‚è±Ô∏è Straordinario</label>
                    </div>
                </div>
                
                <div style="margin-top: 15px;">
                    <button type="button" class="btn btn-primary" onclick="addWorker()">
                        ‚ûï Aggiungi Operaio
                    </button>
                </div>
                
                <div class="items-container" id="workersList">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Nessun operaio aggiunto</p>
                        <p class="small">Aggiungi operai dalla lista sopra</p>
                    </div>
                </div>
                
                <div class="summary-row" style="margin-top: 20px;">
                    <span>Totale Ore Operai:</span>
                    <span id="totalWorkerHours">0</span>
                </div>
                <div class="summary-row">
                    <span>Totale Ore Straordinario:</span>
                    <span id="totalOreStraordinario">0</span>
                </div>
            </div>
            
            <!-- Mezzi -->
            <div class="form-section">
                <h3 class="section-title">üöú Mezzi
                    <button type="button" class="btn btn-sm btn-success" onclick="openManageModal('equipment')">
                        ‚ûï Gestisci Mezzi
                    </button>
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="equipmentSelect">Mezzo *</label>
                        <select id="equipmentSelect" class="form-control">
                            <option value="">Seleziona mezzo...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="equipmentHours">Ore di Utilizzo *</label>
                        <input type="number" id="equipmentHours" class="form-control" min="0" max="24" step="0.5" value="6" placeholder="Ore">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="addEquipment()">
                            ‚ûï Aggiungi Mezzo
                        </button>
                    </div>
                </div>
                
                <div class="items-container" id="equipmentList">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Nessun mezzo aggiunto</p>
                        <p class="small">Aggiungi mezzi dalla lista sopra</p>
                    </div>
                </div>
                
                <div class="summary-row" style="margin-top: 20px;">
                    <span>Totale Ore Mezzi:</span>
                    <span id="totalEquipmentHours">0</span>
                </div>
            </div>
            
            <!-- Lavorazioni -->
            <div class="form-section">
                <h3 class="section-title">üî® Lavorazioni Eseguite
                    <button type="button" class="btn btn-sm btn-success" onclick="openManageModal('works')">
                        ‚ûï Gestisci Lavorazioni
                    </button>
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="workSelect">Tipo Lavorazione *</label>
                        <select id="workSelect" class="form-control">
                            <option value="">Seleziona lavorazione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="workHours">Ore Impiegate *</label>
                        <input type="number" id="workHours" class="form-control" min="0" max="24" step="0.5" value="4" placeholder="Ore">
                    </div>
                    <div class="form-group">
                        <label for="workDescription">Descrizione Dettagliata</label>
                        <input type="text" id="workDescription" class="form-control" placeholder="Dettagli della lavorazione...">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="addWork()">
                            ‚ûï Aggiungi Lavorazione
                        </button>
                    </div>
                </div>
                
                <div class="items-container" id="worksList">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Nessuna lavorazione aggiunta</p>
                        <p class="small">Aggiungi lavorazioni dalla lista sopra</p>
                    </div>
                </div>
                
                <div class="summary-row" style="margin-top: 20px;">
                    <span>Totale Ore Lavorazioni:</span>
                    <span id="totalWorkHours">0</span>
                </div>
            </div>
            
            <!-- Subappaltatori (solo presenza, senza costo) -->
            <div class="form-section">
                <h3 class="section-title">üè¢ Subappaltatori (Presenza)
                    <button type="button" class="btn btn-sm btn-success" onclick="openManageModal('subcontractors')">
                        ‚ûï Gestisci Subappaltatori
                    </button>
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="subcontractorSelect">Subappaltatore</label>
                        <select id="subcontractorSelect" class="form-control">
                            <option value="">Seleziona subappaltatore...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="subcontractorWork">Tipo Lavoro</label>
                        <input type="text" id="subcontractorWork" class="form-control" placeholder="Es. Fornitura calcestruzzo">
                    </div>
                    <div class="form-group">
                        <label for="subcontractorHours">Ore di Lavoro</label>
                        <input type="number" id="subcontractorHours" class="form-control" min="0" step="0.5" value="8" placeholder="Ore">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="button" class="btn btn-primary" onclick="addSubcontractor()">
                            ‚ûï Aggiungi Presenza
                        </button>
                    </div>
                </div>
                
                <div class="items-container" id="subcontractorsList">
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Nessun subappaltatore presente</p>
                        <p class="small">Aggiungi subappaltatori dalla lista sopra</p>
                    </div>
                </div>
                
                <div class="summary-row" style="margin-top: 20px;">
                    <span>Totale Ore Subappalti:</span>
                    <span id="totalSubcontractorHours">0</span>
                </div>
            </div>
            
            <!-- Riepilogo e Salvataggio -->
            <div class="form-section">
                <h3 class="section-title">üíæ Riepilogo Finale</h3>
                <div class="summary-box">
                    <h4 class="summary-title">üìä Riepilogo Giornaliero</h4>
                    <div class="summary-row">
                        <span>Totale Ore Operai:</span>
                        <span id="summaryWorkerHours">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Totale Ore Straordinario:</span>
                        <span id="summaryOreStraordinario">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Operai in Trasferta:</span>
                        <span id="summaryTransferta">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Operai con Pasto:</span>
                        <span id="summaryPasto">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Totale Ore Mezzi:</span>
                        <span id="summaryEquipmentHours">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Totale Ore Lavorazioni:</span>
                        <span id="summaryWorkHours">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Totale Ore Subappalti:</span>
                        <span id="summarySubcontractorHours">0</span>
                    </div>
                    <div class="summary-row">
                        <span>Totale Ore Uomo/Macchina:</span>
                        <span id="summaryTotalHours">0</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 20px; margin-top: 30px;">
                    <button type="button" class="btn btn-danger" onclick="clearReportForm()">
                        ‚ùå Annulla
                    </button>
                    <button type="button" class="btn btn-warning" onclick="saveDraft()">
                        üíæ Salva Bozza
                    </button>
                    <button type="button" class="btn btn-success" onclick="saveReport()" style="flex: 1;">
                        ‚úÖ Salva Rapportino Definitivo
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Tab Gestione Liste -->
        <div class="tab-content" id="manage">
            <div class="form-section">
                <h3 class="section-title">‚öôÔ∏è Gestione Liste</h3>
                <p style="color: #666; margin-bottom: 25px;">Gestisci le liste di operai, mezzi, lavorazioni e subappaltatori disponibili nel sistema.</p>
                
                <div class="quick-actions">
                    <div class="quick-action-btn" onclick="showManageSection('workers')">
                        üë∑ Gestisci Operai
                    </div>
                    <div class="quick-action-btn" onclick="showManageSection('equipment')">
                        üöú Gestisci Mezzi
                    </div>
                    <div class="quick-action-btn" onclick="showManageSection('works')">
                        üî® Gestisci Lavorazioni
                    </div>
                    <div class="quick-action-btn" onclick="showManageSection('subcontractors')">
                        üè¢ Gestisci Subappaltatori
                    </div>
                    <div class="quick-action-btn" onclick="showManageSection('sites')">
                        üèóÔ∏è Gestisci Cantieri
                    </div>
                </div>
                
                <!-- Contenuto dinamico della gestione -->
                <div id="manageContent">
                    <div style="text-align: center; padding: 60px; color: #666;">
                        <p>Seleziona una categoria da gestire</p>
                        <p class="small">Usa i pulsanti sopra per iniziare</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tab Archivio Rapportini -->
        <div class="tab-content" id="reports">
            <div class="form-section">
                <h3 class="section-title">üìã Archivio Rapportini</h3>
                
                <div class="form-row" style="margin-bottom: 25px;">
                    <div class="form-group">
                        <label for="filterMonth">Mese</label>
                        <select id="filterMonth" class="form-control" onchange="filterReports()">
                            <option value="">Tutti i mesi</option>
                            <option value="0">Gennaio</option>
                            <option value="1">Febbraio</option>
                            <option value="2">Marzo</option>
                            <option value="3">Aprile</option>
                            <option value="4">Maggio</option>
                            <option value="5">Giugno</option>
                            <option value="6">Luglio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Settembre</option>
                            <option value="9">Ottobre</option>
                            <option value="10">Novembre</option>
                            <option value="11">Dicembre</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterYear">Anno</label>
                        <select id="filterYear" class="form-control" onchange="filterReports()">
                            <option value="">Tutti gli anni</option>
                            <option value="2023">2023</option>
                            <option value="2024" selected>2024</option>
                            <option value="2025">2025</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterSite">Cantiere</label>
                        <select id="filterSite" class="form-control" onchange="filterReports()">
                            <option value="">Tutti i cantieri</option>
                        </select>
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button class="btn btn-primary" onclick="filterReports()">
                            üîÑ Applica Filtri
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Cantiere</th>
                                <th>Operai</th>
                                <th>Mezzi</th>
                                <th>Lavorazioni</th>
                                <th>Subappalti</th>
                                <th>Ore Totali</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody id="allReportsTable">
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Tab Esporta Excel -->
        <div class="tab-content" id="export">
            <div class="form-section">
                <h3 class="section-title">üìà Esporta Dati in Excel</h3>
                
                <div class="excel-export-section">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">üöÄ Esportazione Mensile</h4>
                    <p style="color: #666; margin-bottom: 20px;">Seleziona il mese e l'anno per esportare tutti i rapportini in formato Excel.</p>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="exportMonth">Mese *</label>
                            <select id="exportMonth" class="form-control" required>
                                <option value="">Seleziona mese...</option>
                                <option value="0">Gennaio</option>
                                <option value="1">Febbraio</option>
                                <option value="2">Marzo</option>
                                <option value="3">Aprile</option>
                                <option value="4">Maggio</option>
                                <option value="5">Giugno</option>
                                <option value="6">Luglio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Settembre</option>
                                <option value="9">Ottobre</option>
                                <option value="10">Novembre</option>
                                <option value="11">Dicembre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exportYear">Anno *</label>
                            <select id="exportYear" class="form-control" required>
                                <option value="">Seleziona anno...</option>
                                <option value="2023">2023</option>
                                <option value="2024" selected>2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="exportSite">Cantiere (opzionale)</label>
                            <select id="exportSite" class="form-control">
                                <option value="">Tutti i cantieri</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin: 25px 0;">
                        <h5 style="color: #1a3c8b; margin-bottom: 15px;">üìä Seleziona Dati da Esportare:</h5>
                        <div class="checkbox-group">
                            <input type="checkbox" id="exportOperai" checked>
                            <label for="exportOperai">üë∑ Dettaglio Operai (ore, trasferta, pasto, straordinario)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="exportMezzi" checked>
                            <label for="exportMezzi">üöú Dettaglio Mezzi</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="exportLavorazioni" checked>
                            <label for="exportLavorazioni">üî® Dettaglio Lavorazioni</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="exportSubappalti" checked>
                            <label for="exportSubappalti">üè¢ Presenza Subappaltatori</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="exportRiepilogo" checked>
                            <label for="exportRiepilogo">üìä Foglio Riepilogo</label>
                        </div>
                    </div>
                    
                    <div style="text-align: center;">
                        <button class="btn btn-success" onclick="exportToExcel()" style="padding: 15px 30px; font-size: 1.1rem;">
                            üì• Esporta Excel Mensile
                        </button>
                        <p style="color: #666; margin-top: 15px; font-size: 0.9rem;">
                            Il file Excel conterr√† tutti i rapportini del mese selezionato
                        </p>
                    </div>
                </div>
                
                <div class="export-options">
                    <div class="export-card">
                        <div class="export-icon">üë∑</div>
                        <h4>Report Operai</h4>
                        <p>Esporta tutte le ore lavorative degli operai</p>
                        <button class="btn btn-primary" onclick="exportWorkersReport()">
                            üìä Esporta Operai
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üî®</div>
                        <h4>Report Lavorazioni</h4>
                        <p>Esporta tutte le lavorazioni eseguite</p>
                        <button class="btn btn-primary" onclick="exportWorksReport()">
                            üìä Esporta Lavorazioni
                        </button>
                    </div>
                    
                    <div class="export-card">
                        <div class="export-icon">üöú</div>
                        <h4>Report Mezzi</h4>
                        <p>Esporta l'utilizzo dei mezzi</p>
                        <button class="btn btn-primary" onclick="exportEquipmentReport()">
                            üìä Esporta Mezzi
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="manageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="manageModalTitle">Gestione</h3>
                <button class="close-modal" onclick="closeModal('manageModal')">√ó</button>
            </div>
            <div id="manageModalContent">
                <!-- Contenuto dinamico -->
            </div>
        </div>
    </div>
    
    <div id="viewReportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="viewReportTitle">Dettagli Rapportino</h3>
                <button class="close-modal" onclick="closeModal('viewReportModal')">√ó</button>
            </div>
            <div id="viewReportContent">
                <!-- Contenuto dinamico -->
            </div>
        </div>
    </div>

    <script>
        // Sistema dati
        let currentUser = null;
        let allReports = [];
        let workers = [];
        let equipment = [];
        let works = [];
        let subcontractors = [];
        let sites = [];
        
        // Dati temporanei per il rapportino corrente
        let currentReport = {
            workers: [],
            equipment: [],
            works: [],
            subcontractors: []
        };
        
        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
            checkAutoLogin();
            initDate();
        });
        
        // Carica tutti i dati
        function loadAllData() {
            // Carica utenti
            const savedUsers = localStorage.getItem('cantiereUsers');
            if (savedUsers) {
                const users = JSON.parse(savedUsers);
                currentUser = users[0] || { name: "Mario Rossi", role: "capocantiere" };
            } else {
                currentUser = { name: "Mario Rossi", role: "capocantiere" };
            }
            
            // Carica liste
            loadWorkers();
            loadEquipment();
            loadWorks();
            loadSubcontractors();
            loadSites();
            
            // Carica rapportini
            const savedReports = localStorage.getItem('cantiereReports');
            if (savedReports) {
                allReports = JSON.parse(savedReports);
            }
            
            // Carica bozze
            const savedDrafts = localStorage.getItem('cantiereDrafts');
            if (savedDrafts) {
                const drafts = JSON.parse(savedDrafts);
                if (drafts.length > 0) {
                    if (confirm('Hai delle bozze salvate. Vuoi caricare l\'ultima?')) {
                        loadDraft(drafts[drafts.length - 1]);
                    }
                }
            }
        }
        
        function loadWorkers() {
            const saved = localStorage.getItem('cantiereWorkers');
            if (saved) {
                workers = JSON.parse(saved);
            } else {
                // Operai predefiniti
                workers = [
                    { id: 1, name: "Mario Rossi", codice: "OP001", active: true },
                    { id: 2, name: "Luigi Verdi", codice: "OP002", active: true },
                    { id: 3, name: "Giovanni Bianchi", codice: "OP003", active: true },
                    { id: 4, name: "Paolo Neri", codice: "OP004", active: true },
                    { id: 5, name: "Antonio Gialli", codice: "OP005", active: true }
                ];
                saveWorkers();
            }
            updateWorkerSelect();
        }
        
        function loadEquipment() {
            const saved = localStorage.getItem('cantiereEquipment');
            if (saved) {
                equipment = JSON.parse(saved);
            } else {
                // Mezzi predefiniti
                equipment = [
                    { id: 1, name: "Escavatore CAT 320", tipo: "escavatore", active: true },
                    { id: 2, name: "Ruspa Komatsu", tipo: "ruspa", active: true },
                    { id: 3, name: "Gru Liebherr", tipo: "gru", active: true },
                    { id: 4, name: "Betoniera", tipo: "betoniera", active: true },
                    { id: 5, name: "Autocarro Iveco", tipo: "autocarro", active: true }
                ];
                saveEquipment();
            }
            updateEquipmentSelect();
        }
        
        function loadWorks() {
            const saved = localStorage.getItem('cantiereWorks');
            if (saved) {
                works = JSON.parse(saved);
            } else {
                // Lavorazioni predefinite
                works = [
                    { id: 1, name: "Scavo fondazioni", categoria: "terra", active: true },
                    { id: 2, name: "Getto calcestruzzo", categoria: "calcestruzzo", active: true },
                    { id: 3, name: "Posa tubazioni", categoria: "idraulica", active: true },
                    { id: 4, name: "Muratura", categoria: "muratura", active: true },
                    { id: 5, name: "Intonacatura", categoria: "finiture", active: true },
                    { id: 6, name: "Demolizione", categoria: "demolizione", active: true },
                    { id: 7, name: "Fornitura materiali", categoria: "fornitura", active: true },
                    { id: 8, name: "Posa impianti elettrici", categoria: "elettrica", active: true }
                ];
                saveWorks();
            }
            updateWorkSelect();
        }
        
        function loadSubcontractors() {
            const saved = localStorage.getItem('cantiereSubcontractors');
            if (saved) {
                subcontractors = JSON.parse(saved);
            } else {
                // Subappaltatori predefiniti
                subcontractors = [
                    { id: 1, name: "EdilCostruzioni S.r.l.", active: true },
                    { id: 2, name: "IdroService S.n.c.", active: true },
                    { id: 3, name: "ElettroImpianti S.r.l.", active: true },
                    { id: 4, name: "Muratori Associati", active: true }
                ];
                saveSubcontractors();
            }
            updateSubcontractorSelect();
        }
        
        function loadSites() {
            const saved = localStorage.getItem('cantiereSites');
            if (saved) {
                sites = JSON.parse(saved);
            } else {
                // Cantieri predefiniti
                sites = [
                    { id: 1, name: "Cantiere Via Roma", indirizzo: "Via Roma, 123", citta: "Roma", active: true },
                    { id: 2, name: "Cantiere Piazza Garibaldi", indirizzo: "Piazza Garibaldi, 45", citta: "Milano", active: true },
                    { id: 3, name: "Cantiere Centro Commerciale", indirizzo: "Viale Europa, 78", citta: "Torino", active: true }
                ];
                saveSites();
            }
            updateSiteSelects();
        }
        
        // Login
        function checkAutoLogin() {
            // Auto-login per semplicit√†
            if (currentUser) {
                showMainApp();
            }
        }
        
        function quickLogin(name, pin) {
            currentUser = { name: name, role: "capocantiere" };
            showMainApp();
        }
        
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            updateUserUI();
            updateDashboard();
            initTabs();
        }
        
        function updateUserUI() {
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = currentUser.role === 'admin' ? 'Amministratore' : 'Capocantiere';
            document.getElementById('userAvatar').textContent = currentUser.role === 'admin' ? 'üëë' : 'üë∑';
        }
        
        function logout() {
            if (confirm('Sei sicuro di voler uscire?')) {
                location.reload();
            }
        }
        
        // Inizializza date
        function initDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('reportDate').value = today;
        }
        
        // Aggiorna select
        function updateWorkerSelect() {
            const select = document.getElementById('workerSelect');
            select.innerHTML = '<option value="">Seleziona operaio...</option>' +
                workers.filter(w => w.active).map(w => 
                    `<option value="${w.id}">${w.name} (${w.codice})</option>`
                ).join('') +
                '<option value="new" class="add-new-option">‚ûï Nuovo operaio...</option>';
        }
        
        function updateEquipmentSelect() {
            const select = document.getElementById('equipmentSelect');
            select.innerHTML = '<option value="">Seleziona mezzo...</option>' +
                equipment.filter(e => e.active).map(e => 
                    `<option value="${e.id}">${e.name} (${e.tipo})</option>`
                ).join('') +
                '<option value="new" class="add-new-option">‚ûï Nuovo mezzo...</option>';
        }
        
        function updateWorkSelect() {
            const select = document.getElementById('workSelect');
            select.innerHTML = '<option value="">Seleziona lavorazione...</option>' +
                works.filter(w => w.active).map(w => 
                    `<option value="${w.id}">${w.name} (${w.categoria})</option>`
                ).join('') +
                '<option value="new" class="add-new-option">‚ûï Nuova lavorazione...</option>';
        }
        
        function updateSubcontractorSelect() {
            const select = document.getElementById('subcontractorSelect');
            select.innerHTML = '<option value="">Seleziona subappaltatore...</option>' +
                subcontractors.filter(s => s.active).map(s => 
                    `<option value="${s.id}">${s.name}</option>`
                ).join('') +
                '<option value="new" class="add-new-option">‚ûï Nuovo subappaltatore...</option>';
        }
        
        function updateSiteSelects() {
            // Select per nuovo rapportino
            const reportSelect = document.getElementById('reportSite');
            reportSelect.innerHTML = '<option value="">Seleziona cantiere...</option>' +
                sites.filter(s => s.active).map(s => 
                    `<option value="${s.id}">${s.name} - ${s.citta}</option>`
                ).join('') +
                '<option value="new" class="add-new-option">‚ûï Nuovo cantiere...</option>';
            
            // Select per filtri
            const filterSelect = document.getElementById('filterSite');
            const exportSelect = document.getElementById('exportSite');
            const uniqueSites = [...new Set(allReports.map(r => r.siteName))];
            
            filterSelect.innerHTML = '<option value="">Tutti i cantieri</option>' +
                uniqueSites.map(site => `<option value="${site}">${site}</option>`).join('');
            
            exportSelect.innerHTML = '<option value="">Tutti i cantieri</option>' +
                uniqueSites.map(site => `<option value="${site}">${site}</option>`).join('');
        }
        
        // Aggiungi elementi al rapportino
        function addWorker() {
            const workerId = document.getElementById('workerSelect').value;
            const hours = parseFloat(document.getElementById('workerHours').value);
            const trasferta = document.getElementById('workerTransferta').checked;
            const pasto = document.getElementById('workerPasto').checked;
            const straordinario = parseFloat(document.getElementById('workerOreStraordinario').value) || 0;
            
            if (!workerId || workerId === 'new') {
                openManageModal('workers');
                return;
            }
            
            if (isNaN(hours) || hours <= 0) {
                alert('Inserisci ore valide (maggiore di 0)');
                return;
            }
            
            const worker = workers.find(w => w.id == workerId);
            if (!worker) return;
            
            currentReport.workers.push({
                id: worker.id,
                name: worker.name,
                codice: worker.codice,
                hours: hours,
                trasferta: trasferta,
                pasto: pasto,
                straordinario: straordinario
            });
            
            updateWorkersList();
            updateSummary();
            
            // Reset form
            document.getElementById('workerHours').value = '8';
            document.getElementById('workerTransferta').checked = false;
            document.getElementById('workerPasto').checked = false;
            document.getElementById('workerOreStraordinario').value = '';
        }
        
        function addEquipment() {
            const equipmentId = document.getElementById('equipmentSelect').value;
            const hours = parseFloat(document.getElementById('equipmentHours').value);
            
            if (!equipmentId || equipmentId === 'new') {
                openManageModal('equipment');
                return;
            }
            
            if (isNaN(hours) || hours <= 0) {
                alert('Inserisci ore valide (maggiore di 0)');
                return;
            }
            
            const eq = equipment.find(e => e.id == equipmentId);
            if (!eq) return;
            
            currentReport.equipment.push({
                id: eq.id,
                name: eq.name,
                tipo: eq.tipo,
                hours: hours
            });
            
            updateEquipmentList();
            updateSummary();
        }
        
        function addWork() {
            const workId = document.getElementById('workSelect').value;
            const hours = parseFloat(document.getElementById('workHours').value);
            const description = document.getElementById('workDescription').value.trim();
            
            if (!workId || workId === 'new') {
                openManageModal('works');
                return;
            }
            
            if (isNaN(hours) || hours <= 0) {
                alert('Inserisci ore valide (maggiore di 0)');
                return;
            }
            
            const work = works.find(w => w.id == workId);
            if (!work) return;
            
            currentReport.works.push({
                id: work.id,
                name: work.name,
                categoria: work.categoria,
                hours: hours,
                description: description || work.name
            });
            
            updateWorksList();
            updateSummary();
            
            // Reset form
            document.getElementById('workHours').value = '4';
            document.getElementById('workDescription').value = '';
        }
        
        function addSubcontractor() {
            const subId = document.getElementById('subcontractorSelect').value;
            const work = document.getElementById('subcontractorWork').value.trim();
            const hours = parseFloat(document.getElementById('subcontractorHours').value) || 0;
            
            if (!subId || subId === 'new') {
                openManageModal('subcontractors');
                return;
            }
            
            const sub = subcontractors.find(s => s.id == subId);
            if (!sub) return;
            
            currentReport.subcontractors.push({
                id: sub.id,
                name: sub.name,
                work: work || "Lavoro generico",
                hours: hours
            });
            
            updateSubcontractorsList();
            updateSummary();
            
            // Reset form
            document.getElementById('subcontractorWork').value = '';
            document.getElementById('subcontractorHours').value = '8';
        }
        
        // Aggiorna liste visualizzate
        function updateWorkersList() {
            const container = document.getElementById('workersList');
            
            if (currentReport.workers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Nessun operaio aggiunto</p>
                        <p class="small">Aggiungi operai dalla lista sopra</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentReport.workers.map((worker, index) => `
                <div class="item-card">
                    <div class="item-info">
                        <div class="item-title">${worker.name}</div>
                        <div class="item-details">Codice: ${worker.codice}</div>
                        <div class="item-details">Ore lavorate: ${worker.hours}
                            ${worker.straordinario > 0 ? `<span class="indicator" style="background: #ffc107; color: #856404; margin-left: 10px;">+${worker.straordinario} straord.</span>` : ''}
                            ${worker.trasferta ? '<span class="indicator indicator-transferta">üöó Trasferta</span>' : ''}
                            ${worker.pasto ? '<span class="indicator indicator-pasto">üçù Pasto</span>' : ''}
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-danger" onclick="removeWorker(${index})">
                            ‚ùå Rimuovi
                        </button>
                    </div>
                </div>
            `).join('');
            
            // Calcola totali
            const totalHours = currentReport.workers.reduce((sum, w) => sum + w.hours, 0);
            const totalStraordinario = currentReport.workers.reduce((sum, w) => sum + (w.straordinario || 0), 0);
            const trasfertaCount = currentReport.workers.filter(w => w.trasferta).length;
            const pastoCount = currentReport.workers.filter(w => w.pasto).length;
            
            document.getElementById('totalWorkerHours').textContent = totalHours.toFixed(1);
            document.getElementById('totalOreStraordinario').textContent = totalStraordinario.toFixed(1);
            document.getElementById('summaryTransferta').textContent = trasfertaCount;
            document.getElementById('summaryPasto').textContent = pastoCount;
        }
        
        function updateEquipmentList() {
            const container = document.getElementById('equipmentList');
            
            if (currentReport.equipment.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Nessun mezzo aggiunto</p>
                        <p class="small">Aggiungi mezzi dalla lista sopra</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentReport.equipment.map((eq, index) => `
                <div class="item-card">
                    <div class="item-info">
                        <div class="item-title">${eq.name}</div>
                        <div class="item-details">Tipo: ${eq.tipo}</div>
                        <div class="item-details">Ore di utilizzo: ${eq.hours}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-danger" onclick="removeEquipment(${index})">
                            ‚ùå Rimuovi
                        </button>
                    </div>
                </div>
            `).join('');
            
            const totalHours = currentReport.equipment.reduce((sum, e) => sum + e.hours, 0);
            document.getElementById('totalEquipmentHours').textContent = totalHours.toFixed(1);
        }
        
        function updateWorksList() {
            const container = document.getElementById('worksList');
            
            if (currentReport.works.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Nessuna lavorazione aggiunta</p>
                        <p class="small">Aggiungi lavorazioni dalla lista sopra</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentReport.works.map((work, index) => `
                <div class="item-card work-item-card">
                    <div class="item-info">
                        <div class="item-title work-item-title">${work.name}</div>
                        <div class="item-details">Categoria: ${work.categoria}</div>
                        <div class="item-details">Ore impiegate: ${work.hours}</div>
                        ${work.description ? `<div class="item-details">Descrizione: ${work.description}</div>` : ''}
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-danger" onclick="removeWork(${index})">
                            ‚ùå Rimuovi
                        </button>
                    </div>
                </div>
            `).join('');
            
            const totalHours = currentReport.works.reduce((sum, w) => sum + w.hours, 0);
            document.getElementById('totalWorkHours').textContent = totalHours.toFixed(1);
        }
        
        function updateSubcontractorsList() {
            const container = document.getElementById('subcontractorsList');
            
            if (currentReport.subcontractors.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <p>Nessun subappaltatore presente</p>
                        <p class="small">Aggiungi subappaltatori dalla lista sopra</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = currentReport.subcontractors.map((sub, index) => `
                <div class="item-card">
                    <div class="item-info">
                        <div class="item-title">${sub.name}</div>
                        <div class="item-details">Lavoro: ${sub.work}</div>
                        <div class="item-details">Ore: ${sub.hours || 'N/A'}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-sm btn-danger" onclick="removeSubcontractor(${index})">
                            ‚ùå Rimuovi
                        </button>
                    </div>
                </div>
            `).join('');
            
            const totalHours = currentReport.subcontractors.reduce((sum, s) => sum + (s.hours || 0), 0);
            document.getElementById('totalSubcontractorHours').textContent = totalHours.toFixed(1);
        }
        
        // Rimuovi elementi
        function removeWorker(index) {
            currentReport.workers.splice(index, 1);
            updateWorkersList();
            updateSummary();
        }
        
        function removeEquipment(index) {
            currentReport.equipment.splice(index, 1);
            updateEquipmentList();
            updateSummary();
        }
        
        function removeWork(index) {
            currentReport.works.splice(index, 1);
            updateWorksList();
            updateSummary();
        }
        
        function removeSubcontractor(index) {
            currentReport.subcontractors.splice(index, 1);
            updateSubcontractorsList();
            updateSummary();
        }
        
        // Aggiorna riepilogo
        function updateSummary() {
            const workerHours = currentReport.workers.reduce((sum, w) => sum + w.hours, 0);
            const equipmentHours = currentReport.equipment.reduce((sum, e) => sum + e.hours, 0);
            const workHours = currentReport.works.reduce((sum, w) => sum + w.hours, 0);
            const subHours = currentReport.subcontractors.reduce((sum, s) => sum + (s.hours || 0), 0);
            const straordinario = currentReport.workers.reduce((sum, w) => sum + (w.straordinario || 0), 0);
            const trasfertaCount = currentReport.workers.filter(w => w.trasferta).length;
            const pastoCount = currentReport.workers.filter(w => w.pasto).length;
            
            const totalHours = workerHours + equipmentHours + workHours + subHours;
            
            document.getElementById('summaryWorkerHours').textContent = workerHours.toFixed(1);
            document.getElementById('summaryOreStraordinario').textContent = straordinario.toFixed(1);
            document.getElementById('summaryTransferta').textContent = trasfertaCount;
            document.getElementById('summaryPasto').textContent = pastoCount;
            document.getElementById('summaryEquipmentHours').textContent = equipmentHours.toFixed(1);
            document.getElementById('summaryWorkHours').textContent = workHours.toFixed(1);
            document.getElementById('summarySubcontractorHours').textContent = subHours.toFixed(1);
            document.getElementById('summaryTotalHours').textContent = totalHours.toFixed(1);
        }
        
        // Salva rapportino
        function saveReport() {
            const date = document.getElementById('reportDate').value;
            const siteId = document.getElementById('reportSite').value;
            const weather = document.getElementById('reportWeather').value;
            const notes = document.getElementById('reportNotes').value;
            
            // Validazioni
            if (!date) {
                alert('Inserisci la data');
                return;
            }
            
            if (!siteId || siteId === 'new') {
                alert('Seleziona un cantiere valido');
                return;
            }
            
            if (currentReport.workers.length === 0) {
                alert('Aggiungi almeno un operaio');
                return;
            }
            
            const site = sites.find(s => s.id == siteId);
            if (!site) {
                alert('Cantiere non trovato');
                return;
            }
            
            // Calcola totali
            const workerHours = currentReport.workers.reduce((sum, w) => sum + w.hours, 0);
            const equipmentHours = currentReport.equipment.reduce((sum, e) => sum + e.hours, 0);
            const workHours = currentReport.works.reduce((sum, w) => sum + w.hours, 0);
            const subHours = currentReport.subcontractors.reduce((sum, s) => sum + (s.hours || 0), 0);
            const straordinario = currentReport.workers.reduce((sum, w) => sum + (w.straordinario || 0), 0);
            const trasfertaCount = currentReport.workers.filter(w => w.trasferta).length;
            const pastoCount = currentReport.workers.filter(w => w.pasto).length;
            const totalHours = workerHours + equipmentHours + workHours + subHours;
            
            // Crea rapportino
            const report = {
                id: Date.now(),
                date: date,
                siteId: site.id,
                siteName: site.name,
                userId: currentUser.id || 1,
                userName: currentUser.name,
                weather: weather,
                notes: notes,
                workers: [...currentReport.workers],
                equipment: [...currentReport.equipment],
                works: [...currentReport.works],
                subcontractors: [...currentReport.subcontractors],
                totals: {
                    workerHours: workerHours,
                    equipmentHours: equipmentHours,
                    workHours: workHours,
                    subcontractorHours: subHours,
                    straordinario: straordinario,
                    trasfertaCount: trasfertaCount,
                    pastoCount: pastoCount,
                    totalHours: totalHours
                },
                createdAt: new Date().toISOString(),
                status: 'completed'
            };
            
            // Aggiungi all'archivio
            allReports.push(report);
            saveReports();
            
            // Aggiorna dashboard
            updateDashboard();
            updateSiteSelects();
            
            // Reset form
            clearReportForm();
            
            // Mostra conferma
            alert(`‚úÖ Rapportino salvato con successo!\n\nüìÖ Data: ${formatDate(date)}\nüèóÔ∏è Cantiere: ${site.name}\nüë∑ Operai: ${currentReport.workers.length}\nüî® Lavorazioni: ${currentReport.works.length}\n‚è±Ô∏è Ore totali: ${totalHours.toFixed(1)}`);
            
            // Torna alla dashboard
            switchTab('dashboard');
        }
        
        function saveDraft() {
            const date = document.getElementById('reportDate').value;
            const siteId = document.getElementById('reportSite').value;
            
            if (!date || !siteId || siteId === 'new') {
                alert('Inserisci almeno data e cantiere per salvare la bozza');
                return;
            }
            
            const site = sites.find(s => s.id == siteId);
            if (!site) return;
            
            const draft = {
                id: Date.now(),
                date: date,
                siteId: site.id,
                siteName: site.name,
                weather: document.getElementById('reportWeather').value,
                notes: document.getElementById('reportNotes').value,
                workers: [...currentReport.workers],
                equipment: [...currentReport.equipment],
                works: [...currentReport.works],
                subcontractors: [...currentReport.subcontractors],
                savedAt: new Date().toISOString()
            };
            
            // Salva bozze
            let drafts = JSON.parse(localStorage.getItem('cantiereDrafts') || '[]');
            drafts.push(draft);
            localStorage.setItem('cantiereDrafts', JSON.stringify(drafts));
            
            alert('üíæ Bozza salvata! Puoi riprenderla pi√π tardi.');
        }
        
        function loadDraft(draft) {
            if (confirm('Caricare questa bozza?')) {
                document.getElementById('reportDate').value = draft.date;
                document.getElementById('reportSite').value = draft.siteId;
                document.getElementById('reportWeather').value = draft.weather || '';
                document.getElementById('reportNotes').value = draft.notes || '';
                
                currentReport.workers = draft.workers || [];
                currentReport.equipment = draft.equipment || [];
                currentReport.works = draft.works || [];
                currentReport.subcontractors = draft.subcontractors || [];
                
                updateWorkersList();
                updateEquipmentList();
                updateWorksList();
                updateSubcontractorsList();
                updateSummary();
                
                switchTab('newReport');
            }
        }
        
        function clearReportForm() {
            // Reset form
            document.getElementById('reportDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('reportSite').selectedIndex = 0;
            document.getElementById('reportWeather').selectedIndex = 0;
            document.getElementById('reportNotes').value = '';
            
            // Reset select
            document.getElementById('workerSelect').selectedIndex = 0;
            document.getElementById('workerHours').value = '8';
            document.getElementById('workerTransferta').checked = false;
            document.getElementById('workerPasto').checked = false;
            document.getElementById('workerOreStraordinario').value = '';
            
            document.getElementById('equipmentSelect').selectedIndex = 0;
            document.getElementById('equipmentHours').value = '6';
            
            document.getElementById('workSelect').selectedIndex = 0;
            document.getElementById('workHours').value = '4';
            document.getElementById('workDescription').value = '';
            
            document.getElementById('subcontractorSelect').selectedIndex = 0;
            document.getElementById('subcontractorWork').value = '';
            document.getElementById('subcontractorHours').value = '8';
            
            // Reset dati temporanei
            currentReport = {
                workers: [],
                equipment: [],
                works: [],
                subcontractors: []
            };
            
            // Reset liste visualizzate
            updateWorkersList();
            updateEquipmentList();
            updateWorksList();
            updateSubcontractorsList();
            updateSummary();
        }
        
        // Gestione liste (modal)
        function openManageModal(type) {
            let title = '';
            let content = '';
            
            switch(type) {
                case 'workers':
                    title = 'üë∑ Gestione Operai';
                    content = getWorkersManageContent();
                    break;
                case 'equipment':
                    title = 'üöú Gestione Mezzi';
                    content = getEquipmentManageContent();
                    break;
                case 'works':
                    title = 'üî® Gestione Lavorazioni';
                    content = getWorksManageContent();
                    break;
                case 'subcontractors':
                    title = 'üè¢ Gestione Subappaltatori';
                    content = getSubcontractorsManageContent();
                    break;
                case 'sites':
                    title = 'üèóÔ∏è Gestione Cantieri';
                    content = getSitesManageContent();
                    break;
            }
            
            document.getElementById('manageModalTitle').textContent = title;
            document.getElementById('manageModalContent').innerHTML = content;
            openModal('manageModal');
        }
        
        function getWorkersManageContent() {
            return `
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Aggiungi Nuovo Operaio</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="newWorkerName" class="form-control" placeholder="Nome e cognome">
                        </div>
                        <div class="form-group">
                            <input type="text" id="newWorkerCode" class="form-control" placeholder="Codice operaio">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success" onclick="addNewWorker()">
                                ‚ûï Aggiungi
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Operai Esistenti</h4>
                    <div class="items-container">
                        ${workers.map(worker => `
                            <div class="item-card">
                                <div class="item-info">
                                    <div class="item-title">${worker.name}</div>
                                    <div class="item-details">Codice: ${worker.codice}</div>
                                    <div class="item-details">
                                        Stato: 
                                        <span style="color: ${worker.active ? '#28a745' : '#dc3545'};">
                                            ${worker.active ? 'Attivo' : 'Inattivo'}
                                        </span>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn btn-sm btn-danger" onclick="toggleWorkerActive(${worker.id})">
                                        ${worker.active ? '‚ùå Disattiva' : '‚úÖ Attiva'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function getEquipmentManageContent() {
            return `
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Aggiungi Nuovo Mezzo</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="newEquipmentName" class="form-control" placeholder="Nome mezzo">
                        </div>
                        <div class="form-group">
                            <select id="newEquipmentType" class="form-control">
                                <option value="">Tipo mezzo</option>
                                <option value="escavatore">Escavatore</option>
                                <option value="ruspa">Ruspa</option>
                                <option value="gru">Gru</option>
                                <option value="betoniera">Betoniera</option>
                                <option value="autocarro">Autocarro</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success" onclick="addNewEquipment()">
                                ‚ûï Aggiungi
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Mezzi Esistenti</h4>
                    <div class="items-container">
                        ${equipment.map(eq => `
                            <div class="item-card">
                                <div class="item-info">
                                    <div class="item-title">${eq.name}</div>
                                    <div class="item-details">Tipo: ${eq.tipo}</div>
                                    <div class="item-details">
                                        Stato: 
                                        <span style="color: ${eq.active ? '#28a745' : '#dc3545'};">
                                            ${eq.active ? 'Attivo' : 'Inattivo'}
                                        </span>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn btn-sm btn-danger" onclick="toggleEquipmentActive(${eq.id})">
                                        ${eq.active ? '‚ùå Disattiva' : '‚úÖ Attiva'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function getWorksManageContent() {
            return `
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Aggiungi Nuova Lavorazione</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="newWorkName" class="form-control" placeholder="Nome lavorazione">
                        </div>
                        <div class="form-group">
                            <select id="newWorkCategory" class="form-control">
                                <option value="">Categoria</option>
                                <option value="terra">Terra</option>
                                <option value="calcestruzzo">Calcestruzzo</option>
                                <option value="muratura">Muratura</option>
                                <option value="finiture">Finiture</option>
                                <option value="idraulica">Idraulica</option>
                                <option value="elettrica">Elettrica</option>
                                <option value="demolizione">Demolizione</option>
                                <option value="fornitura">Fornitura</option>
                                <option value="altro">Altro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success" onclick="addNewWork()">
                                ‚ûï Aggiungi
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Lavorazioni Esistenti</h4>
                    <div class="items-container">
                        ${works.map(work => `
                            <div class="item-card work-item-card">
                                <div class="item-info">
                                    <div class="item-title work-item-title">${work.name}</div>
                                    <div class="item-details">Categoria: ${work.categoria}</div>
                                    <div class="item-details">
                                        Stato: 
                                        <span style="color: ${work.active ? '#28a745' : '#dc3545'};">
                                            ${work.active ? 'Attivo' : 'Inattivo'}
                                        </span>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn btn-sm btn-danger" onclick="toggleWorkActive(${work.id})">
                                        ${work.active ? '‚ùå Disattiva' : '‚úÖ Attiva'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function getSubcontractorsManageContent() {
            return `
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Aggiungi Nuovo Subappaltatore</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="newSubcontractorName" class="form-control" placeholder="Ragione sociale">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success" onclick="addNewSubcontractor()">
                                ‚ûï Aggiungi
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Subappaltatori Esistenti</h4>
                    <div class="items-container">
                        ${subcontractors.map(sub => `
                            <div class="item-card">
                                <div class="item-info">
                                    <div class="item-title">${sub.name}</div>
                                    <div class="item-details">
                                        Stato: 
                                        <span style="color: ${sub.active ? '#28a745' : '#dc3545'};">
                                            ${sub.active ? 'Attivo' : 'Inattivo'}
                                        </span>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn btn-sm btn-danger" onclick="toggleSubcontractorActive(${sub.id})">
                                        ${sub.active ? '‚ùå Disattiva' : '‚úÖ Attiva'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        function getSitesManageContent() {
            return `
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Aggiungi Nuovo Cantiere</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="text" id="newSiteName" class="form-control" placeholder="Nome cantiere">
                        </div>
                        <div class="form-group">
                            <input type="text" id="newSiteAddress" class="form-control" placeholder="Indirizzo">
                        </div>
                        <div class="form-group">
                            <input type="text" id="newSiteCity" class="form-control" placeholder="Citt√†">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-success" onclick="addNewSite()">
                                ‚ûï Aggiungi
                            </button>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">Cantieri Esistenti</h4>
                    <div class="items-container">
                        ${sites.map(site => `
                            <div class="item-card">
                                <div class="item-info">
                                    <div class="item-title">${site.name}</div>
                                    <div class="item-details">${site.indirizzo}, ${site.citta}</div>
                                    <div class="item-details">
                                        Stato: 
                                        <span style="color: ${site.active ? '#28a745' : '#dc3545'};">
                                            ${site.active ? 'Attivo' : 'Inattivo'}
                                        </span>
                                    </div>
                                </div>
                                <div class="item-actions">
                                    <button class="btn btn-sm btn-danger" onclick="toggleSiteActive(${site.id})">
                                        ${site.active ? '‚ùå Disattiva' : '‚úÖ Attiva'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // Funzioni per aggiungere nuovi elementi
        function addNewWorker() {
            const name = document.getElementById('newWorkerName').value.trim();
            const code = document.getElementById('newWorkerCode').value.trim();
            
            if (!name) {
                alert('Inserisci il nome dell\'operaio');
                return;
            }
            
            const newWorker = {
                id: Date.now(),
                name: name,
                codice: code || `OP${Date.now().toString().slice(-4)}`,
                active: true
            };
            
            workers.push(newWorker);
            saveWorkers();
            updateWorkerSelect();
            
            closeModal('manageModal');
            openManageModal('workers');
            
            setTimeout(() => {
                document.getElementById('workerSelect').value = newWorker.id;
            }, 100);
        }
        
        function addNewEquipment() {
            const name = document.getElementById('newEquipmentName').value.trim();
            const type = document.getElementById('newEquipmentType').value;
            
            if (!name) {
                alert('Inserisci il nome del mezzo');
                return;
            }
            
            if (!type) {
                alert('Seleziona il tipo di mezzo');
                return;
            }
            
            const newEquipment = {
                id: Date.now(),
                name: name,
                tipo: type,
                active: true
            };
            
            equipment.push(newEquipment);
            saveEquipment();
            updateEquipmentSelect();
            
            closeModal('manageModal');
            openManageModal('equipment');
            
            setTimeout(() => {
                document.getElementById('equipmentSelect').value = newEquipment.id;
            }, 100);
        }
        
        function addNewWork() {
            const name = document.getElementById('newWorkName').value.trim();
            const category = document.getElementById('newWorkCategory').value;
            
            if (!name) {
                alert('Inserisci il nome della lavorazione');
                return;
            }
            
            if (!category) {
                alert('Seleziona la categoria');
                return;
            }
            
            const newWork = {
                id: Date.now(),
                name: name,
                categoria: category,
                active: true
            };
            
            works.push(newWork);
            saveWorks();
            updateWorkSelect();
            
            closeModal('manageModal');
            openManageModal('works');
            
            setTimeout(() => {
                document.getElementById('workSelect').value = newWork.id;
            }, 100);
        }
        
        function addNewSubcontractor() {
            const name = document.getElementById('newSubcontractorName').value.trim();
            
            if (!name) {
                alert('Inserisci la ragione sociale');
                return;
            }
            
            const newSubcontractor = {
                id: Date.now(),
                name: name,
                active: true
            };
            
            subcontractors.push(newSubcontractor);
            saveSubcontractors();
            updateSubcontractorSelect();
            
            closeModal('manageModal');
            openManageModal('subcontractors');
            
            setTimeout(() => {
                document.getElementById('subcontractorSelect').value = newSubcontractor.id;
            }, 100);
        }
        
        function addNewSite() {
            const name = document.getElementById('newSiteName').value.trim();
            const address = document.getElementById('newSiteAddress').value.trim();
            const city = document.getElementById('newSiteCity').value.trim();
            
            if (!name) {
                alert('Inserisci il nome del cantiere');
                return;
            }
            
            const newSite = {
                id: Date.now(),
                name: name,
                indirizzo: address,
                citta: city,
                active: true
            };
            
            sites.push(newSite);
            saveSites();
            updateSiteSelects();
            
            closeModal('manageModal');
            openManageModal('sites');
            
            setTimeout(() => {
                document.getElementById('reportSite').value = newSite.id;
            }, 100);
        }
        
        // Toggle active status
        function toggleWorkerActive(id) {
            const worker = workers.find(w => w.id === id);
            if (worker) {
                worker.active = !worker.active;
                saveWorkers();
                updateWorkerSelect();
                openManageModal('workers');
            }
        }
        
        function toggleEquipmentActive(id) {
            const eq = equipment.find(e => e.id === id);
            if (eq) {
                eq.active = !eq.active;
                saveEquipment();
                updateEquipmentSelect();
                openManageModal('equipment');
            }
        }
        
        function toggleWorkActive(id) {
            const work = works.find(w => w.id === id);
            if (work) {
                work.active = !work.active;
                saveWorks();
                updateWorkSelect();
                openManageModal('works');
            }
        }
        
        function toggleSubcontractorActive(id) {
            const sub = subcontractors.find(s => s.id === id);
            if (sub) {
                sub.active = !sub.active;
                saveSubcontractors();
                updateSubcontractorSelect();
                openManageModal('subcontractors');
            }
        }
        
        function toggleSiteActive(id) {
            const site = sites.find(s => s.id === id);
            if (site) {
                site.active = !site.active;
                saveSites();
                updateSiteSelects();
                openManageModal('sites');
            }
        }
        
        // Dashboard e statistiche
        function updateDashboard() {
            document.getElementById('totalReports').textContent = allReports.length;
            document.getElementById('totalWorkers').textContent = workers.filter(w => w.active).length;
            document.getElementById('totalWorks').textContent = works.filter(w => w.active).length;
            
            updateRecentReports();
        }
        
        function updateRecentReports() {
            const table = document.getElementById('recentReportsTable');
            const recent = allReports.slice(-10).reverse();
            
            table.innerHTML = recent.map(report => `
                <tr>
                    <td>${formatDate(report.date)}</td>
                    <td>${report.siteName}</td>
                    <td>${report.workers.length}</td>
                    <td>${report.equipment.length}</td>
                    <td>${report.works.length}</td>
                    <td>${report.totals.totalHours.toFixed(1)}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewReport(${report.id})">
                            üëÅÔ∏è Vedi
                        </button>
                    </td>
                </tr>
            `).join('');
            
            if (recent.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #666;">
                            Nessun rapportino trovato
                        </td>
                    </tr>
                `;
            }
        }
        
        function filterReports() {
            const month = document.getElementById('filterMonth').value;
            const year = document.getElementById('filterYear').value;
            const site = document.getElementById('filterSite').value;
            
            let filtered = allReports;
            
            if (month !== '') {
                filtered = filtered.filter(r => new Date(r.date).getMonth() == month);
            }
            
            if (year !== '') {
                filtered = filtered.filter(r => new Date(r.date).getFullYear() == year);
            }
            
            if (site !== '') {
                filtered = filtered.filter(r => r.siteName === site);
            }
            
            // Ordina per data (pi√π recente prima)
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const table = document.getElementById('allReportsTable');
            table.innerHTML = filtered.map(report => `
                <tr>
                    <td>${formatDate(report.date)}</td>
                    <td>${report.siteName}</td>
                    <td>${report.workers.length} operai</td>
                    <td>${report.equipment.length} mezzi</td>
                    <td>${report.works.length} lavorazioni</td>
                    <td>${report.subcontractors.length} subappalti</td>
                    <td>${report.totals.totalHours.toFixed(1)} ore</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewReport(${report.id})">
                            üëÅÔ∏è Vedi
                        </button>
                    </td>
                </tr>
            `).join('');
            
            if (filtered.length === 0) {
                table.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #666;">
                            Nessun rapportino trovato con i filtri selezionati
                        </td>
                    </tr>
                `;
            }
        }
        
        function viewReport(id) {
            const report = allReports.find(r => r.id === id);
            if (!report) return;
            
            document.getElementById('viewReportTitle').textContent = `Rapportino - ${formatDate(report.date)}`;
            
            document.getElementById('viewReportContent').innerHTML = `
                <div style="margin-bottom: 25px;">
                    <p><strong>üìÖ Data:</strong> ${formatDate(report.date)}</p>
                    <p><strong>üèóÔ∏è Cantiere:</strong> ${report.siteName}</p>
                    <p><strong>üë∑ Capocantiere:</strong> ${report.userName}</p>
                    <p><strong>üå§Ô∏è Meteo:</strong> ${getWeatherText(report.weather)}</p>
                    <p><strong>üìù Note:</strong> ${report.notes || 'Nessuna nota'}</p>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">üë∑ Operai (${report.workers.length})</h4>
                    ${report.workers.length > 0 ? 
                        report.workers.map(w => `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>${w.name}</strong> (${w.codice}) - ${w.hours} ore
                                ${w.straordinario > 0 ? `<br><small>+${w.straordinario} ore straordinario</small>` : ''}
                                ${w.trasferta ? '<span class="indicator indicator-transferta" style="margin-left: 10px;">üöó Trasferta</span>' : ''}
                                ${w.pasto ? '<span class="indicator indicator-pasto" style="margin-left: 10px;">üçù Pasto</span>' : ''}
                            </div>
                        `).join('') :
                        '<p>Nessun operaio registrato</p>'
                    }
                    <p><strong>Totale ore operai:</strong> ${report.totals.workerHours.toFixed(1)}</p>
                    <p><strong>Totale ore straordinario:</strong> ${report.totals.straordinario.toFixed(1)}</p>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">üöú Mezzi (${report.equipment.length})</h4>
                    ${report.equipment.length > 0 ? 
                        report.equipment.map(e => `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>${e.name}</strong> (${e.tipo}) - ${e.hours} ore
                            </div>
                        `).join('') :
                        '<p>Nessun mezzo registrato</p>'
                    }
                    <p><strong>Totale ore mezzi:</strong> ${report.totals.equipmentHours.toFixed(1)}</p>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">üî® Lavorazioni (${report.works.length})</h4>
                    ${report.works.length > 0 ? 
                        report.works.map(w => `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>${w.name}</strong> (${w.categoria}) - ${w.hours} ore
                                ${w.description ? `<br><small>${w.description}</small>` : ''}
                            </div>
                        `).join('') :
                        '<p>Nessuna lavorazione registrata</p>'
                    }
                    <p><strong>Totale ore lavorazioni:</strong> ${report.totals.workHours.toFixed(1)}</p>
                </div>
                
                ${report.subcontractors.length > 0 ? `
                    <div style="margin-bottom: 25px;">
                        <h4 style="color: #1a3c8b; margin-bottom: 15px;">üè¢ Subappaltatori (${report.subcontractors.length})</h4>
                        ${report.subcontractors.map(s => `
                            <div style="margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                <strong>${s.name}</strong><br>
                                Lavoro: ${s.work}<br>
                                Ore: ${s.hours || 'N/A'}
                            </div>
                        `).join('')}
                        <p><strong>Totale ore subappalti:</strong> ${report.totals.subcontractorHours.toFixed(1)}</p>
                    </div>
                ` : ''}
                
                <div style="background: #f0f5ff; padding: 20px; border-radius: 8px;">
                    <h4 style="color: #1a3c8b; margin-bottom: 15px;">üìä Riepilogo Totale</h4>
                    <p><strong>‚è±Ô∏è Ore totali uomo/macchina:</strong> ${report.totals.totalHours.toFixed(1)}</p>
                    <p><strong>üöó Operai in trasferta:</strong> ${report.totals.trasfertaCount}</p>
                    <p><strong>üçù Operai con pasto:</strong> ${report.totals.pastoCount}</p>
                    <p><strong>üìÖ Creato il:</strong> ${formatDateTime(report.createdAt)}</p>
                </div>
            `;
            
            openModal('viewReportModal');
        }
        
        // ESPORTAZIONE EXCEL
        function exportToExcel() {
            const month = document.getElementById('exportMonth').value;
            const year = document.getElementById('exportYear').value;
            const site = document.getElementById('exportSite').value;
            
            if (!month || !year) {
                alert('Seleziona mese e anno per esportare');
                return;
            }
            
            // Filtra rapportini per mese/anno
            let filteredReports = allReports.filter(r => {
                const reportDate = new Date(r.date);
                return reportDate.getMonth() == month && 
                       reportDate.getFullYear() == year &&
                       (site === '' || r.siteName === site);
            });
            
            if (filteredReports.length === 0) {
                alert('Nessun rapportino trovato per il periodo selezionato');
                return;
            }
            
            // Crea workbook
            const wb = XLSX.utils.book_new();
            
            // Foglio riepilogo
            if (document.getElementById('exportRiepilogo').checked) {
                const summaryData = createSummarySheet(filteredReports, month, year);
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, wsSummary, 'Riepilogo');
            }
            
            // Foglio operai
            if (document.getElementById('exportOperai').checked) {
                const workersData = createWorkersSheet(filteredReports);
                const wsWorkers = XLSX.utils.aoa_to_sheet(workersData);
                XLSX.utils.book_append_sheet(wb, wsWorkers, 'Operai');
            }
            
            // Foglio mezzi
            if (document.getElementById('exportMezzi').checked) {
                const equipmentData = createEquipmentSheet(filteredReports);
                const wsEquipment = XLSX.utils.aoa_to_sheet(equipmentData);
                XLSX.utils.book_append_sheet(wb, wsEquipment, 'Mezzi');
            }
            
            // Foglio lavorazioni
            if (document.getElementById('exportLavorazioni').checked) {
                const worksData = createWorksSheet(filteredReports);
                const wsWorks = XLSX.utils.aoa_to_sheet(worksData);
                XLSX.utils.book_append_sheet(wb, wsWorks, 'Lavorazioni');
            }
            
            // Foglio subappalti
            if (document.getElementById('exportSubappalti').checked) {
                const subcontractorsData = createSubcontractorsSheet(filteredReports);
                const wsSubcontractors = XLSX.utils.aoa_to_sheet(subcontractorsData);
                XLSX.utils.book_append_sheet(wb, wsSubcontractors, 'Subappalti');
            }
            
            // Genera nome file
            const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", 
                              "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            const fileName = `Rapportini_${monthNames[month]}_${year}${site ? '_' + site.replace(/\s+/g, '_') : ''}.xlsx`;
            
            // Salva file
            XLSX.writeFile(wb, fileName);
            
            alert(`‚úÖ File Excel "${fileName}" generato con successo!`);
        }
        
        function createSummarySheet(reports, month, year) {
            const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", 
                              "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            
            const data = [
                ['RIEPILOGO MENSILE RAPPORTINI CANTIERE'],
                [`Mese: ${monthNames[month]} ${year}`],
                [''],
                ['Data', 'Cantiere', 'Operai', 'Mezzi', 'Lavorazioni', 'Subappalti', 'Ore Totali', 'Ore Straord.', 'Trasferte', 'Pasto'],
                ...reports.map(r => [
                    formatDate(r.date),
                    r.siteName,
                    r.workers.length,
                    r.equipment.length,
                    r.works.length,
                    r.subcontractors.length,
                    r.totals.totalHours.toFixed(1),
                    r.totals.straordinario.toFixed(1),
                    r.totals.trasfertaCount,
                    r.totals.pastoCount
                ]),
                [''],
                ['TOTALI MENSILI:'],
                ['', '', '', '', '', '',
                    reports.reduce((sum, r) => sum + r.totals.totalHours, 0).toFixed(1),
                    reports.reduce((sum, r) => sum + r.totals.straordinario, 0).toFixed(1),
                    reports.reduce((sum, r) => sum + r.totals.trasfertaCount, 0),
                    reports.reduce((sum, r) => sum + r.totals.pastoCount, 0)
                ]
            ];
            
            return data;
        }
        
        function createWorkersSheet(reports) {
            // Raccogli tutti gli operai dai rapportini
            const allWorkers = {};
            
            reports.forEach(report => {
                report.workers.forEach(worker => {
                    const key = `${worker.name}_${worker.codice}`;
                    if (!allWorkers[key]) {
                        allWorkers[key] = {
                            name: worker.name,
                            codice: worker.codice,
                            totalHours: 0,
                            straordinario: 0,
                            trasfertaCount: 0,
                            pastoCount: 0,
                            days: []
                        };
                    }
                    
                    allWorkers[key].totalHours += worker.hours;
                    allWorkers[key].straordinario += (worker.straordinario || 0);
                    if (worker.trasferta) allWorkers[key].trasfertaCount++;
                    if (worker.pasto) allWorkers[key].pastoCount++;
                    allWorkers[key].days.push({
                        date: report.date,
                        site: report.siteName,
                        hours: worker.hours,
                        straordinario: worker.straordinario || 0,
                        trasferta: worker.trasferta,
                        pasto: worker.pasto
                    });
                });
            });
            
            // Crea dati per il foglio
            const data = [
                ['DETTAGLIO ORE OPERAI'],
                [''],
                ['Operaio', 'Codice', 'Ore Totali', 'Ore Straordinario', 'Giorni Trasferta', 'Giorni Pasto', 'Numero Giorni'],
                ...Object.values(allWorkers).map(w => [
                    w.name,
                    w.codice,
                    w.totalHours.toFixed(1),
                    w.straordinario.toFixed(1),
                    w.trasfertaCount,
                    w.pastoCount,
                    w.days.length
                ]),
                [''],
                ['DETTAGLIO GIORNALIERO PER OPERAIO'],
                ['Data', 'Cantiere', 'Operaio', 'Codice', 'Ore', 'Straordinario', 'Trasferta', 'Pasto']
            ];
            
            // Aggiungi dettaglio giornaliero
            Object.values(allWorkers).forEach(w => {
                w.days.forEach(day => {
                    data.push([
                        formatDate(day.date),
                        day.site,
                        w.name,
                        w.codice,
                        day.hours,
                        day.straordinario,
                        day.trasferta ? 'SI' : 'NO',
                        day.pasto ? 'SI' : 'NO'
                    ]);
                });
            });
            
            return data;
        }
        
        function createEquipmentSheet(reports) {
            const allEquipment = {};
            
            reports.forEach(report => {
                report.equipment.forEach(eq => {
                    const key = `${eq.name}_${eq.tipo}`;
                    if (!allEquipment[key]) {
                        allEquipment[key] = {
                            name: eq.name,
                            tipo: eq.tipo,
                            totalHours: 0,
                            days: []
                        };
                    }
                    
                    allEquipment[key].totalHours += eq.hours;
                    allEquipment[key].days.push({
                        date: report.date,
                        site: report.siteName,
                        hours: eq.hours
                    });
                });
            });
            
            const data = [
                ['DETTAGLIO UTILIZZO MEZZI'],
                [''],
                ['Mezzo', 'Tipo', 'Ore Totali', 'Numero Giorni'],
                ...Object.values(allEquipment).map(eq => [
                    eq.name,
                    eq.tipo,
                    eq.totalHours.toFixed(1),
                    eq.days.length
                ]),
                [''],
                ['DETTAGLIO GIORNALIERO PER MEZZO'],
                ['Data', 'Cantiere', 'Mezzo', 'Tipo', 'Ore']
            ];
            
            Object.values(allEquipment).forEach(eq => {
                eq.days.forEach(day => {
                    data.push([
                        formatDate(day.date),
                        day.site,
                        eq.name,
                        eq.tipo,
                        day.hours
                    ]);
                });
            });
            
            return data;
        }
        
        function createWorksSheet(reports) {
            const allWorks = {};
            
            reports.forEach(report => {
                report.works.forEach(work => {
                    const key = `${work.name}_${work.categoria}`;
                    if (!allWorks[key]) {
                        allWorks[key] = {
                            name: work.name,
                            categoria: work.categoria,
                            totalHours: 0,
                            days: []
                        };
                    }
                    
                    allWorks[key].totalHours += work.hours;
                    allWorks[key].days.push({
                        date: report.date,
                        site: report.siteName,
                        hours: work.hours,
                        description: work.description
                    });
                });
            });
            
            const data = [
                ['DETTAGLIO LAVORAZIONI'],
                [''],
                ['Lavorazione', 'Categoria', 'Ore Totali', 'Numero Giorni'],
                ...Object.values(allWorks).map(w => [
                    w.name,
                    w.categoria,
                    w.totalHours.toFixed(1),
                    w.days.length
                ]),
                [''],
                ['DETTAGLIO GIORNALIERO PER LAVORAZIONE'],
                ['Data', 'Cantiere', 'Lavorazione', 'Categoria', 'Ore', 'Descrizione']
            ];
            
            Object.values(allWorks).forEach(w => {
                w.days.forEach(day => {
                    data.push([
                        formatDate(day.date),
                        day.site,
                        w.name,
                        w.categoria,
                        day.hours,
                        day.description || ''
                    ]);
                });
            });
            
            return data;
        }
        
        function createSubcontractorsSheet(reports) {
            const allSubcontractors = {};
            
            reports.forEach(report => {
                report.subcontractors.forEach(sub => {
                    if (!allSubcontractors[sub.name]) {
                        allSubcontractors[sub.name] = {
                            name: sub.name,
                            totalHours: 0,
                            days: []
                        };
                    }
                    
                    allSubcontractors[sub.name].totalHours += (sub.hours || 0);
                    allSubcontractors[sub.name].days.push({
                        date: report.date,
                        site: report.siteName,
                        work: sub.work,
                        hours: sub.hours || 0
                    });
                });
            });
            
            const data = [
                ['PRESENZA SUBAPPALTATORI'],
                [''],
                ['Subappaltatore', 'Ore Totali', 'Numero Giorni'],
                ...Object.values(allSubcontractors).map(sub => [
                    sub.name,
                    sub.totalHours.toFixed(1),
                    sub.days.length
                ]),
                [''],
                ['DETTAGLIO GIORNALIERO'],
                ['Data', 'Cantiere', 'Subappaltatore', 'Lavoro', 'Ore']
            ];
            
            Object.values(allSubcontractors).forEach(sub => {
                sub.days.forEach(day => {
                    data.push([
                        formatDate(day.date),
                        day.site,
                        sub.name,
                        day.work,
                        day.hours
                    ]);
                });
            });
            
            return data;
        }
        
        // Funzioni di export specifiche
        function exportWorkersReport() {
            const month = document.getElementById('exportMonth').value;
            const year = document.getElementById('exportYear').value;
            
            if (!month || !year) {
                alert('Seleziona mese e anno per esportare');
                return;
            }
            
            let filteredReports = allReports.filter(r => {
                const reportDate = new Date(r.date);
                return reportDate.getMonth() == month && reportDate.getFullYear() == year;
            });
            
            if (filteredReports.length === 0) {
                alert('Nessun rapportino trovato per il periodo selezionato');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const workersData = createWorkersSheet(filteredReports);
            const ws = XLSX.utils.aoa_to_sheet(workersData);
            XLSX.utils.book_append_sheet(wb, ws, 'Operai');
            
            const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", 
                              "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            XLSX.writeFile(wb, `Report_Operai_${monthNames[month]}_${year}.xlsx`);
        }
        
        function exportWorksReport() {
            const month = document.getElementById('exportMonth').value;
            const year = document.getElementById('exportYear').value;
            
            if (!month || !year) {
                alert('Seleziona mese e anno per esportare');
                return;
            }
            
            let filteredReports = allReports.filter(r => {
                const reportDate = new Date(r.date);
                return reportDate.getMonth() == month && reportDate.getFullYear() == year;
            });
            
            if (filteredReports.length === 0) {
                alert('Nessun rapportino trovato per il periodo selezionato');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const worksData = createWorksSheet(filteredReports);
            const ws = XLSX.utils.aoa_to_sheet(worksData);
            XLSX.utils.book_append_sheet(wb, ws, 'Lavorazioni');
            
            const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", 
                              "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            XLSX.writeFile(wb, `Report_Lavorazioni_${monthNames[month]}_${year}.xlsx`);
        }
        
        function exportEquipmentReport() {
            const month = document.getElementById('exportMonth').value;
            const year = document.getElementById('exportYear').value;
            
            if (!month || !year) {
                alert('Seleziona mese e anno per esportare');
                return;
            }
            
            let filteredReports = allReports.filter(r => {
                const reportDate = new Date(r.date);
                return reportDate.getMonth() == month && reportDate.getFullYear() == year;
            });
            
            if (filteredReports.length === 0) {
                alert('Nessun rapportino trovato per il periodo selezionato');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            const equipmentData = createEquipmentSheet(filteredReports);
            const ws = XLSX.utils.aoa_to_sheet(equipmentData);
            XLSX.utils.book_append_sheet(wb, ws, 'Mezzi');
            
            const monthNames = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", 
                              "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
            XLSX.writeFile(wb, `Report_Mezzi_${monthNames[month]}_${year}.xlsx`);
        }
        
        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('it-IT');
        }
        
        function getWeatherText(weather) {
            const weatherMap = {
                'sole': '‚òÄÔ∏è Soleggiato',
                'nuvoloso': '‚òÅÔ∏è Nuvoloso',
                'pioggia': 'üåßÔ∏è Pioggia',
                'neve': '‚ùÑÔ∏è Neve',
                'vento': 'üí® Ventoso'
            };
            return weatherMap[weather] || 'Non specificato';
        }
        
        // Tabs
        function initTabs() {
            const tabs = document.querySelectorAll('.main-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(tabId).classList.add('active');
                    
                    if (tabId === 'reports') {
                        filterReports();
                    } else if (tabId === 'manage') {
                        showManageSection('workers');
                    } else if (tabId === 'export') {
                        // Inizializza select per esportazione
                        const currentDate = new Date();
                        document.getElementById('exportMonth').value = currentDate.getMonth();
                        document.getElementById('exportYear').value = currentDate.getFullYear();
                    }
                });
            });
        }
        
        function switchTab(tabName) {
            document.querySelector(`[data-tab="${tabName}"]`).click();
        }
        
        function showManageSection(section) {
            const content = document.getElementById('manageContent');
            let html = '';
            
            switch(section) {
                case 'workers':
                    html = getWorkersManageContent();
                    break;
                case 'equipment':
                    html = getEquipmentManageContent();
                    break;
                case 'works':
                    html = getWorksManageContent();
                    break;
                case 'subcontractors':
                    html = getSubcontractorsManageContent();
                    break;
                case 'sites':
                    html = getSitesManageContent();
                    break;
            }
            
            content.innerHTML = html;
        }
        
        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Save functions
        function saveWorkers() {
            localStorage.setItem('cantiereWorkers', JSON.stringify(workers));
        }
        
        function saveEquipment() {
            localStorage.setItem('cantiereEquipment', JSON.stringify(equipment));
        }
        
        function saveWorks() {
            localStorage.setItem('cantiereWorks', JSON.stringify(works));
        }
        
        function saveSubcontractors() {
            localStorage.setItem('cantiereSubcontractors', JSON.stringify(subcontractors));
        }
        
        function saveSites() {
            localStorage.setItem('cantiereSites', JSON.stringify(sites));
        }
        
        function saveReports() {
            localStorage.setItem('cantiereReports', JSON.stringify(allReports));
        }
    </script>
</body>
</html>
